<article class="bcls-article">
<section class="bcls-section">
<h2 id="Introduction">Introduction</h2>

<p>This sample creates a simple Live job with three output renditions: 1080p, 720p, and 480p.</p>

<p>Because the Live API is not CORS-enabled and must be accessed from a server-side app, the API request is sent through a simple proxy written in PHP. You can reproduce this in any server-side language - all it does is collect the request parameters sent by the JavaScript, sends the request to the API, and returns the response to the JavaScript. All the code can be found in the <a href="#code">code section below</a>.</p>
</section>

<section class="bcls-section">
<h2 id="inputs">App inputs</h2>

<p>Live API Key: <input id="live_key" type="text" /></p>

<p>Select region: <select name="regionSelect" id="regionSelect"></select></p>

<p><button id="sendButton" class="bcls-button">Create the Job</button></p>
</section>

<section class="bcls-section">
<h2 id="outputs">App outputs</h2>

<h3>Log</h3>

<p>Request body</p>
<textarea name="reqBody" id="reqBody" class="bcls-code" rows="8" cols="80"></textarea>

<h3>Playback URLs</h3>

<p><code>stream_url</code></p>
<textarea name="stream_url" id="stream_url" cols="100" rows="2" class="bcls-code"></textarea>

<p><code>playback_url</code></p>
<textarea name="playback_url" id="playback_url" cols="100" rows="2" class="bcls-code"></textarea>

<p><code>playback_url_dvr</code></p>
<textarea name="playback_url_dvr" id="playback_url_dvr" cols="100" rows="2" class="bcls-code"></textarea>

<h3>Full response</h3>

<pre class="line-numbers"><code id="apiResponse">Response will appear here...</code></pre>
</section>

<section class="bcls-section">
<h2 id="code">Code for this sample</h2>

<h3>HTML</h3>

<pre class="line-numbers">
<code class="language-html">&lt;section class="bcls-section"&gt;
  &lt;h2 id="inputs"&gt;App inputs&lt;/h2&gt;
  &lt;p&gt;Live API Key: &lt;input id="live_key" type="text"&gt;&lt;/p&gt;
  &lt;p&gt;Select region: &lt;select name="regionSelect" id="regionSelect"&gt;&lt;/select&gt;&lt;/p&gt;
  &lt;p&gt;&lt;button id="sendButton" class="bcls-button"&gt;Create the Job&lt;/button&gt;&lt;/p&gt;
&lt;/section&gt;
&lt;section class="bcls-section"&gt;
  &lt;h2 id="outputs"&gt;App outputs&lt;/h2&gt;
  &lt;h3&gt;Log&lt;/h3&gt;
  &lt;p&gt;Request body&lt;/p&gt;
  &lt;textarea name="reqBody" id="reqBody" class="bcls-code" rows="8" cols="80"&gt;&lt;/textarea&gt;
  &lt;h3&gt;Playback URLs&lt;/h3&gt;
  &lt;p&gt;&lt;code&gt;stream_url&lt;/code&gt;&lt;/p&gt;
  &lt;textarea name="stream_url" id="stream_url" cols="100" rows="2" class="bcls-code"&gt;&lt;/textarea&gt;
  &lt;p&gt;&lt;code&gt;playback_url&lt;/code&gt;&lt;/p&gt;
  &lt;textarea name="playback_url" id="playback_url" cols="100" rows="2" class="bcls-code"&gt;&lt;/textarea&gt;
  &lt;p&gt;&lt;code&gt;playback_url_dvr&lt;/code&gt;&lt;/p&gt;
  &lt;textarea name="playback_url_dvr" id="playback_url_dvr" cols="100" rows="2" class="bcls-code"&gt;&lt;/textarea&gt;

  &lt;h3&gt;Full response&lt;/h3&gt;
&lt;pre class="line-numbers"&gt;&lt;code id="apiResponse" class="language-json"&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/section&gt;
</code></pre>

<h3>JavaScript</h3>

<pre class="line-numbers">
<code class="language-javascript">var BCLS = ( function (window, document) {
  var live_key       = document.getElementById('live_key'),
    regionSelect     = document.getElementById('regionSelect'),
    stream_url       = document.getElementById('stream_url'),
    playback_url     = document.getElementById('playback_url'),
    playback_url_dvr = document.getElementById('playback_url_dvr'),
    apiResponse      = document.getElementById('apiResponse'),
    sendButton       = document.getElementById('sendButton'),
    reqBody          = document.getElementById('reqBody'),
    proxyURL         = 'https://solutions.brightcove.com/bcls/bcls-proxy/live-proxy.php',
    regions          = ['us-west-1', 'us-west-2', 'us-east-1', 'us-east-2', 'eu-west-1', 'eu-west-2', 'ap-southeast-2', 'ap-northeast-1', 'ap-southeast-1', 'eu-central-1', 'sa-east-1', 'ap-south-1'],
    apiKey           = '6aaXAZSSzRatgbVo7P12v7g13ovsuemr3y0CLGkR',
    body             = JSON.parse('{"live_stream":true,"region":"us-west-2","reconnect_time":20,"live_sliding_window_duration":30,"outputs":[{"label":"hls1080p","live_stream":true,"width":1920,"height":1080,"video_codec":"h264","h264_profile":"main","video_bitrate":2400,"segment_seconds":6,"keyframe_interval":60},{"label":"hls720p","live_stream":true,"width":1280,"height":720,"video_codec":"h264","h264_profile":"main","video_bitrate":1843,"segment_seconds":6,"keyframe_interval":60},{"label":"hls480p","live_stream":true,"width":640,"height":360,"video_codec":"h264","h264_profile":"main","video_bitrate":819,"segment_seconds":6,"keyframe_interval":60}]}'),
    requestURL       = 'https://api.bcovlive.io/v1/jobs',
    fragment         = document.createDocumentFragment(),
    option,
    i,
    iMax;

  // build select options
  iMax = regions.length;
  for (i = 0; i &lt; iMax; i++) {
    option = document.createElement('option');
    option.setAttribute('value', regions[i]);
    option.textContent = regions[i];
    if (regions[i] === 'us-west-2') {
      option.setAttribute('selected', 'selected');
    }
    fragment.appendChild(option);
  }
  regionSelect.appendChild(fragment);

  // event handlers

  sendButton.addEventListener('click', function() {
    if (isDefined(live_key.value)) {
      createRequest();
    } else {
      alert('You must provide a Live API Key');
    }
  });

  /**
   * get selected value for single select element
   * @param {htmlElement} e the select element
   * @return {Object} object containing the `value`, text, and selected `index`
   */
  function getSelectedValue(e) {
      var selected = e.options[e.selectedIndex],
          val = selected.value,
          txt = selected.textContent,
          idx = e.selectedIndex;
      return {
          value: val,
          text: txt,
          index: idx
      };
  }

  /**
   * tests for all the ways a variable might be undefined or not have a value
   * @param {*} x the variable to test
   * @return {Boolean} true if variable is defined and has a value
   */
  function isDefined(x) {
      if ( x === '' || x === null || x === undefined) {
          return false;
      }
      return true;
  }

  /*
   * tests to see if a string is json
   * @param {String} str string to test
   * @return {Boolean}
   */
  function isJson(str) {
      try {
          JSON.parse(str);
      } catch (e) {
          return false;
      }
      return true;
  }

  /**
   * prepares the api request and handles the response
   */
    function createRequest() {
      var options = {},
        responseDecoded,
        playlist;
      body.region = getSelectedValue(regionSelect).value;
      options.url = requestURL;
      reqBody.textContent = JSON.stringify(body);
      options.requestBody = JSON.stringify(body);
      options.requestType = 'POST';
      options.apiKey = live_key.value;
      makeRequest(options, function(response) {
        if (isJson(response)) {
          responseDecoded = JSON.parse(response);
          apiResponse.textContent = JSON.stringify(responseDecoded, null, '  ');
          stream_url.textContent = responseDecoded.stream_url;
          playback_url.textContent = responseDecoded.playback_url;
          playback_url_dvr.textContent = responseDecoded.playback_url_dvr;
        } else {
          apiResponse.textContent = response;
        }
      });
    }

  /**
   * send API request to the proxy
   * @param  {Object} options options for the request
   * @param  {String} requestID the type of request = id of the button
   * @param  {Function} [callback] callback function
   */
  function makeRequest(options, callback) {
    var httpRequest = new XMLHttpRequest(),
      responseRaw,
      parsedData,
      requestParams,
      dataString,
      renditions,
      field,
      i = 0,
      iMax,
      // response handler
      getResponse = function() {
        try {
          if (httpRequest.readyState === 4) {
            if (httpRequest.status &gt;= 200 &amp;&amp; httpRequest.status &lt; 300) {
              // check for completion
              responseRaw = httpRequest.responseText;
              callback(responseRaw);
            }
          }
        } catch (e) {
          alert('Caught Exception: ' + e);
        }
      };
    // set up request data
    requestParams = 'url=' + encodeURIComponent(options.url) + '&amp;requestType=' + options.requestType + '&amp;apiKey=' + options.apiKey + '&amp;requestBody=' + options.requestBody;

    // set response handler
    httpRequest.onreadystatechange = getResponse;
    // open the request
    httpRequest.open('POST', proxyURL);
    // set headers
    httpRequest.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    // open and send request
    httpRequest.send(requestParams);
  }

})(window, document);
</code></pre>

<h3>Proxy (PHP)</h3>

<pre class="line-numbers">
<code class="language-php">&lt;?php
/**
 * bcls-proxy.php - proxy for Brightcove RESTful APIs
 * gets an access token, makes the request, and returns the response
 * Accessing:
 *    (note you should *always* access the proxy via HTTPS)
 *    Method: POST
 *
 * @post {string} url - the URL for the API request
 * @post {string} [requestType=GET] - HTTP method for the request
 * @post {string} [requestBody] - JSON data to be sent with write requests
 * @post {string} apiKey - Live API key
 *
 * @returns {string} $response - JSON response received from the API
 */


// CORS enablement and other headers
header("Access-Control-Allow-Origin: *");
header("Content-type: application/json");
header("X-Content-Type-Options: nosniff");
header("X-XSS-Protection");


// set up the API call
// get data
if ($_POST["requestBody"]) {
    $data = json_decode($_POST["requestBody"]);
}
// get api key
$apikey = $_POST["apiKey"];
// get request type or default to GET
if ($_POST["requestType"]) {
    $method = $_POST["requestType"];
} else {
    $method = "GET";
}
// security checks
$needle = '.io';
$endapi = strpos($_POST["url"], $needle) + 3;

$nextChar = substr($_POST['url'], $endapi, 1);

if (strpos($_POST["url"], 'api.bcovlive.io') == false) {
    exit('{"ERROR":"Only requests to Brightcove Live APIs are accepted by this proxy"}');
} else if ($nextChar !== '/' &amp;&amp; $nextChar !== '?') {
    exit('{"ERROR": "There was a problem with your API request - please check the URL"}');
}
// get the URL and authorization info from the form data
$request = $_POST["url"];
//send the http request
if ($_POST["requestBody"]) {
  $ch = curl_init($request);
  curl_setopt_array($ch, array(
    CURLOPT_CUSTOMREQUEST  =&gt; $method,
    CURLOPT_RETURNTRANSFER =&gt; TRUE,
    CURLOPT_SSL_VERIFYPEER =&gt; FALSE,
    CURLOPT_HTTPHEADER     =&gt; array(
      'Content-type: application/json',
      "X-API-KEY: {$apikey}",
    ),
    CURLOPT_POSTFIELDS =&gt; json_encode($data)
  ));
  $response = curl_exec($ch);
  curl_close($ch);
} else {
  $ch = curl_init($request);
  curl_setopt_array($ch, array(
    CURLOPT_CUSTOMREQUEST  =&gt; $method,
    CURLOPT_RETURNTRANSFER =&gt; TRUE,
    CURLOPT_SSL_VERIFYPEER =&gt; FALSE,
    CURLOPT_HTTPHEADER     =&gt; array(
      'Content-type: application/json',
      "X-API-KEY: {$apikey}",
    )
  ));
  $response = curl_exec($ch);
  curl_close($ch);
}

// Check for errors
if ($response === FALSE) {
    $logEntry = "\nError:\n".
    "\n".date("Y-m-d H:i:s")." UTC \n"
    .$response;
    $logFileLocation = "log.txt";
    $fileHandle      = fopen($logFileLocation, 'a') or die("-1");
    fwrite($fileHandle, $logEntry);
    fclose($fileHandle);
    echo '{"ERROR": "There was a problem with your API call"}'+
    die(curl_error($ch));
}

// Decode the response
// $responseData = json_decode($response, TRUE);
// return the response to the AJAX caller
$responseDecoded = json_decode($response);
// if (!isset($responseDecoded)) {
// 	$response = '{null}';
// }
echo $response;
?&gt;
</code></pre>
</section>
</article>
<script src="//learning-services-media.brightcove.com/doc-assets/node/18519-live-api-sample-create-live-job/create-job.js">

</script>
