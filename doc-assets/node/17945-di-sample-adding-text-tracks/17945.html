<section class="bcls-section">
<h2 id="Overview">Overview</h2>

<p>In this sample, we display videos from an account 20 at time (using the CMS API), and allow the user to add WebVTT captions to one or more of the displayed videos. The sample can be easily modified to add thumbnail and/or poster images instead, or to retrancode the videos. The main point of the sample is to go beyond the basic API requests to show you how to assemble them into a real app.</p>

<p>Below is a schematic view of the app logic.</p>

<figure class="bcls-figure"><img class="bcls-image" alt="App Logic" src="//learning-services-media.brightcove.com/doc-assets/video-cloud-apis/di-api/samples/sample-app/sample-app-logic.svg" />
<figcaption class="bcls-caption--image">App Logic</figcaption>
</figure>

<p>The app is also designed to be used by multiple users on one or multiple accounts. It doesn't actually do that, but in the explanation below, you'll see where the hooks are to pull user information from some backend system. (Alternatively, you could ask users for account ids and client credentials on each use, as most of our API samples do.)</p>

<aside class="bcls-aside bcls-aside--information">Dynamic Ingest does <strong>not</strong> have a mechanism for processing multiple videos - this sample simply iterates over a set of videos to make a Dynamic Ingest request for each one.</aside>
</section>

<section class="bcls-section">
<h2 id="gettingCredentials" class="bcls-expander-head">Getting Credentials</h2>

<div class="bcls-expander-content">
<p>To get a <code>client_id</code> and <code>client_secret</code>, you will need to go to the OAuth UI and register this app:</p>

<ul>
	<li><a href="/node/14056">Managing API Authentication Credentials</a></li>
</ul>

<p>These are the permissions you will need:</p>

<figure class="bcls-figure"><img class="bcls-image" alt="Dynamic Ingest Permissions" src="//learning-services-media.brightcove.com/doc-assets/video-cloud-apis/di-api/di-permissions.png" />
<figcaption class="bcls-caption--image">Dynamic Ingest Permissions</figcaption>
</figure>

<p>You can also get your credentials via CURL or Postman - see:</p>

<ul>
	<li><a href="/node/17924">Get Client Credentials Using CURL</a></li>
	<li><a href="/node/17923">Get Client Credentials Using Postman</a></li>
</ul>

<p>If you are getting credentials directly from the API, these are the permissions you need:</p>

<pre class="line-numbers">
<code class="language-json">[
  "video-cloud/video/all",
  "video-cloud/ingest-profiles/profile/read",
  "video-cloud/ingest-profiles/account/read",
  "video-cloud/upload-urls/read"
]</code></pre>
</div>
</section>

<section class="bcls-section">
<h2 id="rateLimiting">Rate limiting</h2>

<p>See <a href="/node/17949#best_practices">Best Practices</a> for information on rate limiting.</p>
</section>

<section class="bcls-section">
<h2 id="the_app">The app</h2>

<p>The sample app is embedded in the CodePen below.</p>

<p data-height="900" data-theme-id="light" data-slug-hash="vgLLQp" data-default-tab="result" data-user="bcls" data-embed-version="2" data-pen-title="Sample App for Dynamic Ingest" data-editable="true" class="codepen">See the Pen <a href="http://codepen.io/team/bcls/pen/vgLLQp/">Sample App for Dynamic Ingest</a> by Brightcove Learning Services (<a href="http://codepen.io/bcls">@bcls</a>) on <a href="http://codepen.io">CodePen</a>.</p>
<script async src="https://production-assets.codepen.io/assets/embed/ei.js"></script><script async src="https://production-assets.codepen.io/assets/embed/ei.js"></script><script async src="https://production-assets.codepen.io/assets/embed/ei.js"></script></section>

<p>&lt; class="bcls-section"&gt;</p>

<h2 id="htmlNotes">HTML and CSS notes</h2>

<h3>HTML</h3>

<p>The HTML is quite simple - the video list is generated dynamically by JavaScript from the response to the CMS API calls. You may notice that the video name appears twice on many of the videos. This is not an error - in this demo account, we simply reused the video name for the description in many cases.</p>

<p>The three buttons allow the user to page through the video library, select videos, and request captions - there are event handlers in the JavaScript for each of these.</p>

<h3>CSS</h3>

<p>The CSS code is also very basic.</p>

<section class="bcls-section">
<h2 id="javascriptNotes">JavaScript notes</h2>

<ul>
	<li>The main work is done by the functions <code>createRequest()</code> (lines 146-265) and <code>makeRequest()</code> (lines 267-329).</li>
	<li><code>createRequest()</code> sets up the API requests. A <code>switch</code> block is used to set up 3 kinds of requests:
	<ol>
		<li>The <code>getVideoCount</code> case sets up a CMS API request to get the total number of videos in the account. When it gets the response, it does a little math to figure out how many sets of 20 videos there are.</li>
		<li>The <code>getVideos</code> case gets sets of 20 videos by sending requests to the CMS API. When it gets the response, it does some basic DOM manipulation to inject a checkbox, thumnail image, and video title and description into a table in the HTML.</li>
		<li>The <code>addCaptions</code> cases sends the API requests to the Dynamic Ingest API to add the captions to each of the selected videos (realistically, you would have captions for each video, but here we're just adding same sample WebVTT files [line 23] to each video). Lines 241-48 construct the request body - this is where you could modify the app to do something else like add images to the video. Note that we wait for the response on each video before sending the next request - we recommend that you do this rather than just firing off all the requests in a <code>for</code> loop, as this helps to minimize the chances of violating the Dynamic Ingest rate limit.</li>
	</ol>
	</li>
	<li><code>makeRequest()</code> is simpler. It's a basic AJAX machine that takes options passed to it and posts them to a proxy app that makes the actual API request and returns the response. The function just passes that response back to the source of the request via a callback function.</li>
	<li>The rest of code is mainly utility functions for enabling/disabling buttons, checking and unchecking checkboxes, and so forth.</li>
	<li>There are also event listener for the buttons, and a <code>window load</code> event listener that gets the video count and fetches the first set of videos as soon as the page loads. (Use the <code>window</code> load event, as it is more reliable across browsers than the <code>document</code> load event.)</li>
	<li>Note the <code>customer_id</code> variable (line 29), which is passed to proxy for all requests, so that the proxy can retrieve the appropriate client credentials. If you are building an app for one organization and Video Cloud account, you don't need this - instead you could just embed the client credentials in the proxy code. The important thing is <code>not</code> to embed the client credentials in the client-side code, where they can be easily stolen.</li>
	<li>There are many comments in the code to explain the details of the different function.</li>
</ul>
</section>

<section class="bcls-section">
<h2 id="phpNotes">PHP proxy notes</h2>

<p>The code discussed below is not part of the CodePen - these are additional pieces on the server side.</p>

<h4>Proxy code</h4>

<aside class="bcls-aside bcls-aside--information">In order to build your own version the sample app on this page, you must create and host your own proxy. (The proxies used by Brightcove Learning Services only accept requests from Brightcove domains.)</aside>

<p>The proxy is a simple PHP app that takes the requests posted from the JavaScript and performs three functions:</p>

<ul>
	<li>Fetch the user client credentials from a JSON file (discussed below)</li>
	<li>Make a request to the Brightcove OAuth API to get an access token for the API request</li>
	<li>Make the API request and return the response to the caller</li>
</ul>

<p>The complete code for the proxy is shown below.</p>

<pre class="line-numbers">
<code class="language-php">&lt;?php
/**
 * bcls-proxy.php - proxy for Brightcove RESTful APIs
 * gets an access token, makes the request, and returns the response
 * Accessing:
 *     Method: POST
 *
 * @post {string} customer_id the customer id
 * @post {string} url - the URL for the API request
 * @post {string} [requestType=GET] - HTTP method for the request
 * @post {string} [requestBody=null] - JSON data to be sent with write requests
 *
 * @returns {string} $response - JSON response received from the API
 */

// CORS enablement and other headers
header("Access-Control-Allow-Origin: *");
header("Content-type: application/json");
header("X-Content-Type-Options: nosniff");

/**
 * Note that I don't know how you store/retrieve customer data
 * so here I've just stored what I need in a JSON file and am going
 * to read it in based on the customer id
 */
// get customer data
$customer_id = $_POST["customer_id"];
$customer_data_file = 'customers.json';
$file_contents = file_get_contents($customer_data_file);
$contents_decoded = json_decode($file_contents);
$customer_data = $contents_decoded-&gt;$customer_id;

// set up request for access token
$data = array();

$client_id = $customer_data-&gt;client_id;
$client_secret = $customer_data-&gt;client_secret;

$auth_string = "{$client_id}:{$client_secret}";
$request     = "https://oauth.brightcove.com/v3/access_token?grant_type=client_credentials";
$ch          = curl_init($request);
curl_setopt_array($ch, array(
        CURLOPT_POST           =&gt; TRUE,
        CURLOPT_RETURNTRANSFER =&gt; TRUE,
        CURLOPT_SSL_VERIFYPEER =&gt; FALSE,
        CURLOPT_USERPWD        =&gt; $auth_string,
        CURLOPT_HTTPHEADER     =&gt; array(
            'Content-type: application/x-www-form-urlencoded',
        ),
        CURLOPT_POSTFIELDS =&gt; $data
    ));
$response = curl_exec($ch);
curl_close($ch);

// Check for errors
if ($response === FALSE) {
    die(curl_error($ch));
}

// Decode the response
$responseData = json_decode($response, TRUE);
$access_token = $responseData["access_token"];

// set up the API call
// get data
if ($_POST["requestBody"]) {
    $data = json_decode($_POST["requestBody"]);
} else {
    $data = array();
}
// get request type or default to GET
if ($_POST["requestType"]) {
    $method = $_POST["requestType"];
} else {
    $method = "GET";
}

// get the URL and authorization info from the form data
$request = $_POST["url"];
//send the http request
$ch = curl_init($request);
curl_setopt_array($ch, array(
        CURLOPT_CUSTOMREQUEST  =&gt; $method,
        CURLOPT_RETURNTRANSFER =&gt; TRUE,
        CURLOPT_SSL_VERIFYPEER =&gt; FALSE,
        CURLOPT_HTTPHEADER     =&gt; array(
            'Content-type: application/json',
            "Authorization: Bearer {$access_token}",
        ),
        CURLOPT_POSTFIELDS =&gt; json_encode($data)
    ));
$response = curl_exec($ch);
curl_close($ch);

// Check for errors
if ($response === FALSE) {
    $logEntry = "\nError:\n".
    "\n".date("Y-m-d H:i:s")." UTC \n"
    .$response;
    $logFileLocation = "log.txt";
    $fileHandle      = fopen($logFileLocation, 'a') or die("-1");
    fwrite($fileHandle, $logEntry);
    fclose($fileHandle);
    echo "Error: there was a problem with your API call"+
    die(curl_error($ch));
}

// Decode the response
// $responseData = json_decode($response, TRUE);
// return the response to the AJAX caller
$responseDecoded = json_decode($response);
if (!isset($responseDecoded)) {
    $response = '{null}';
}
echo $response;
?&gt;</code></pre>

<aside class="bcls-aside bcls-aside--information">Omitted from the code are some security checks we use to ensure that requests posted to proxy originate from a Brightcove server - if you app will reside entirely within a firewall, you don't need to worry about that, but if it will be on a public URL, you should probably include your own checks.</aside>

<h5>Notes on the proxy</h5>

<ul>
	<li>This doesn't have to be done in PHP - any server-side language is fine</li>
	<li>Line 21-31: based on the customer id sent by the caller, we get the appropriate client credentials from a JSON file - as noted earlier, if you are building an app for a single account, you could just include the <code>client_id</code> and <code>client_secret</code> here.</li>
	<li>Lines 33-62: makes the request to the Brightcove OAuth API to get an access token</li>
	<li>Lines 64-115: makes the API request and sends the response back to the caller</li>
</ul>
</section>

<section class="bcls-section">
<h2 id="dataFileNotes">Customer data file</h2>

<p>The JSON file that the proxy fetches customer data from is very simple:</p>

<pre class="line-numbers">
<code class="language-json">{
  "customer1": {
    "client_secret": "<span class="bcls-input">client_secret_here</span>",
    "client_id": "<span class="bcls-input">client_id here</span>",
    "account_id": "1485884786001"
  }
}</code></pre>
</section>
<script src="//learning-services-media.brightcove.com/doc-assets/video-cloud-apis/di-api/samples/batch-ingest/di-ingest.js"></script>
