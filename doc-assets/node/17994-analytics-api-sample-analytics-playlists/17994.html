<article class="bcls-article">
<section class="bcls-section">
<h2 id="Notes">Limitations</h2>

<aside class="bcls-aside bcls-aside--information">
<ul>
	<li>You must retrieve playlist data and select a playlist before submitting the request to the Analytics API</li>
	<li>For smart playlists, analytics data will be returned for videos currently in the playlist - data will not be returned for videos that are no longer in the playlist because they have been deactivated, deleted, or removed because the definition of the playlist has changed</li>
	<li>If any of the videos are also published in single video players, or in multiple playlists, you will need to specify the player to get accurate data for a specific playlist</li>
	<li>The returned data includes the data for individual videos plus cumulative or average values for the playlist</li>
	<li>If the returned data does not include items for all videos in the playlist, no data was returned for those videos over the time period specified</li>
</ul>
</aside>
</section>

<section class="bcls-section">
<h2 id="logic">App Logic</h2>

<p>This is a hybrid app that uses the CMS API to retrieve playlist information, and then the Analytics API to retrieve analytics for the videos in the playlist. There is a slight twist: for EXPLICIT (manual) playlist, the metadata includes the video ids, so we can take those directly to the Analytics API; for smart playlists, however, we need to go back to CMS API using the search, sort, and limit criteria for the playlist to get the video information, which we can then take to the Analytics API:</p>

<figure class="bcls-figure"><img class="bcls-image" alt="App Logic" src="//learning-services-media.brightcove.com/doc-assets/video-cloud-apis/analytics-api/code-samples/analytics-by-playlist/get-analytics-by-playlist.png" />
<figcaption class="bcls-caption--image">App Logic</figcaption>
</figure>
</section>

<section class="bcls-section">
<h2 id="gettingCredentials" class="bcls-expander-head">Getting Credentials</h2>

<div class="bcls-expander-content">
<p>To get a <code>client_id</code> and <code>client_secret</code>, you will need to go to the OAuth UI and register this app:</p>

<ul>
	<li><a href="/node/14056">Managing API Authentication Credentials</a></li>
</ul>

<p>These are the permissions you will need:</p>

<figure class="bcls-figure"><img class="bcls-image" alt="Analytics API Permissions" src="//learning-services-media.brightcove.com/doc-assets/video-cloud-apis/analytics-api/aapi-playlist-permissions.png" />
<figcaption class="bcls-caption--image">Analytics API Permissions</figcaption>
</figure>

<p>You can also get your credentials via CURL or Postman - see:</p>

<ul>
	<li><a href="/node/17924">Get Client Credentials Using CURL</a></li>
	<li><a href="/node/17923">Get Client Credentials Using Postman</a></li>
</ul>

<p>If you are getting credentials directly from the API, these are the permissions you need:</p>

<pre class="line-numbers">
<code class="language-json">[
  "video-cloud/analytics/read",
  "video-cloud/video/read",
  "video-cloud/video/read"
]</code></pre>
</div>
</section>

<section class="bcls-section">
<h2 id="Request_Options">Request Options</h2>

<p>Where no default value is indicated, there is none.</p>

<div id="inputFields" class="input-fields">
<fieldset class="bcls-fieldset"><legend>Basic Information</legend>

<p>By default, you will get results from the Brightcove Training Videos account.</p>

<p><button class="bcls-button" id="useMyAccount">Use My Account Instead</button></p>

<div id="basicInfo" style="display:none;">
<table class="bcls-table">
	<tbody class="bcls-table__body">
		<tr>
			<td>Video Cloud Account (Publisher ID):</td>
			<td><input id="accountID" class="required aapi-request" type="text" size="55" /></td>
		</tr>
		<tr>
			<td class="align-top no-wrap">Client id:</td>
			<td><input id="client_id" class="required aapi-request" type="text" size="100" value="" /> (must include permissions for Analytics/Read, Videos/Read, and Playlists/Read)</td>
		</tr>
		<tr>
			<td class="align-top no-wrap">Client secret:</td>
			<td><input id="client_secret" class="required aapi-request" type="text" size="100" value="" /> (must include permissions for Analytics/Read, Videos/Read, and Playlists/Read)
			options
			</td>
		</tr>
	</tbody>
</table>

</div>
</fieldset>

<fieldset class="bcls-fieldset"><legend>Select Playlist</legend>

<p><button class="bcls-button" id="getPlaylists">Get Playlists</button></p>

<div class="bcls-hidden" id="playlistSelectWrapper">
<p id="playlists"><select id="playlistSelector"></select></p>
</div>
</fieldset>

<fieldset id="aapiParams" class="bcls-hidden"><legend>Filters</legend>

<div id="filters">
<table class="bcls-table">
	<tbody class="bcls-table__body">
		<tr>
			<td>From:</td>
			<td>Date: <input class="date-range" id="from" type="text" size="30" /> (default: 30 days ago -- choose the same date for From and To to get a report for that day)</td>
		</tr>
		<tr>
			<td>To:</td>
			<td>Date: <input class="date-range" id="to" type="text" size="30" /> (default: now)</td>
		</tr>
		<tr>
			<td>Where:</td>
			<td>Player ID = <input id="player" class="where-input aapi-request" type="text" size="40" value="" /></td>
		</tr>
		<tr>
			<td>Format for response data</td>
			<td><select id="format"><option selected="selected">json</option><option>csv</option></select></td>
		</tr>
	</tbody>
</table>
</div>
</fieldset>
</div>
</section>

<section class="bcls-section">
<h2 id="API_Request">API Request</h2>

<div id="requestSubmitter" class="bcls-hidden">
<fieldset class="bcls-fieldset"><legend>Generated Request</legend>

<p>API Request</p>
<textarea id="request" name="request" class="bcls-code"></textarea></fieldset>

<p><button class="bcls-button" id="submitButton">Submit Request</button></p>
</div>
</section>

<section class="bcls-section">
<h2 id="response">Response</h2>

<p>In the <strong>Summary</strong> portion of the response, you will find average values for the playlist.</p>

<pre class="line-numbers"><code class="language-json" id="responseFrame">Response will appear here...</code></pre>
</section>

<section class="bcls-section">
<h2 id="jscode">JavaScript Code</h2>

<p>JavaScript code for this sample:</p>

<pre class="line-numbers">
<code class="language-javascript">var BCLS = (function (window, document, Pikaday) {
    'use strict';
    var // media api stuff
        getPlaylists,
        limit = 25,
        offset = 0,
        playlistData = [],
        analyticsData = {},
        useMyAccount = document.getElementById('useMyAccount'),
        basicInfo = document.getElementById('basicInfo'),
        $accountInputs = document.getElementById('accountInputs'),
        $playlistInfo = document.getElementById('playlistInfo'),
        proxyURL = 'https://solutions.brightcove.com/bcls/bcls-proxy/analytics-by-playlist.php',
        $account_id = document.getElementById('accountID'),
        account_id = '1752604059001',
        $client_id = document.getElementById('client_id'),
        $client_secret = document.getElementById('client_secret'),
        client_id,
        client_secret,
        $APIrequestType = document.getElementById('aapiRequestType'),
        requestType,
        $accountID = document.getElementById('accountID'),
        $dimension = document.getElementById('dimension'),
        fromPicker,
        toPicker,
        to = document.getElementById('to'),
        from = document.getElementById('from'),
        $player = document.getElementById('player'),
        $requestButton = document.getElementById('requestButton'),
        $request = document.getElementById('request'),
        $requestForm = document.getElementById('requestForm'),
        $aapiParams = document.getElementById('aapiParams'),
        $requestSubmitter = document.getElementById('requestSubmitter'),
        $submitButton = document.getElementById('submitButton'),
        $format = document.getElementById('format'),
        $directVideoInput = document.getElementById('directVideoInput'),
        $responseFrame = document.getElementById('responseFrame'),
        separator = '',
        requestTrimmed = false,
        lastChar = '',
        requestURL = '',
        endDate = '',
        startDate = '',
        $getPlaylists = document.getElementById('getPlaylists'),
        $playlistSelectWrapper = document.getElementById('playlistSelectWrapper'),
        $playlistSelector = document.getElementById('playlistSelector'),
        playlistSelector = document.getElementById('playlistSelector'),
        videoIds = [],
        isJSON = true,
        searchString,
        playlistLimit,
        playlistSort,
        totalPlaylists = 0,
        totalPlaylistCalls = 0,
        callNumber = 0,
        gettingData = false,
        now = new Date(),
        nowMS = now.valueOf(),
        fromMS = nowMS - (30 * 24 * 60 * 60 * 1000),
        fromDate = new Date(fromMS),
        nowISO = now.toISOString().substr(0, 10),
        fromISO = fromDate.toISOString().substr(0, 10);
    // utilities
    function bclslog(context, message) {
        if (console) {
            console.log(context, message);
        }
    }
    // more robust test for strings 'not defined'
    function isDefined(v) {
        if (v === '' || v === null || v === 'undefined' || v === undefined) {
            return false;
        }
        return true;
    }

    /**
     * get selected value for single select element
     * @param {htmlElement} e the select element
     * @return {Object} object containing the `value` and selected `index` and 'data-playlist-index'
     */
    function getSelectedPlaylist(e) {
        var val = e.options[e.selectedIndex].value,
            playlistIndex = parseInt(e.options[e.selectedIndex].getAttribute('data-playlist-index')),
            idx = e.selectedIndex;
        return {
            value: val,
            playlistIndex: playlistIndex,
            index: idx
        };
    }

    /**
     * get selected value for single select element
     * @param {htmlElement} e the select element
     * @return {Object} object containing the `value` and selected `index`
     */
    function getSelectedValue(e) {
        var val = e.options[e.selectedIndex].value,
            idx = e.selectedIndex;
        return {
            value: val,
            index: idx
        };
    }

    /**
     * handler for playlist selection
     * get the videos from the playlist metadata or the search criteria
     * and then invokes the Analytics API request
     */
    function onPlaylistSelect() {
        bclslog('playlist selected');
        var selectedPlaylistObj = getSelectedPlaylist(playlistSelector),
            selectedPlaylist = playlistData[selectedPlaylistObj.playlistIndex];

        switch (selectedPlaylist.type) {
            case 'EXPLICIT':
                videoIds = selectedPlaylist.video_ids;
                break;
            case 'ACTIVATED_OLDEST_TO_NEWEST':
                searchString = selectedPlaylist.search;
                playlistLimit = selectedPlaylist.limit;
                playlistSort = 'published_at';
                buildRequest('getVideos');
                break;
            case 'ACTIVATED_NEWEST_TO_OLDEST':
                searchString = selectedPlaylist.search;
                playlistLimit = selectedPlaylist.limit;
                playlistSort = encodeURI('-published_at');
                buildRequest('getVideos');
                break;
            case 'ALPHABETICAL':
                searchString = selectedPlaylist.search;
                playlistLimit = selectedPlaylist.limit;
                playlistSort = 'name';
                buildRequest('getVideos');
                break;
            case 'PLAYS_TOTAL':
                searchString = selectedPlaylist.search;
                playlistLimit = selectedPlaylist.limit;
                playlistSort = encodeURI('-plays_total');
                buildRequest('getVideos');
                break;
            case 'PLAYS_TRAILING_WEEK':
                searchString = selectedPlaylist.search;
                playlistLimit = selectedPlaylist.limit;
                playlistSort = 'plays_trailing_week';
                buildRequest('getVideos');
                break;
            case 'START_DATE_OLDEST_TO_NEWEST':
                searchString = selectedPlaylist.search;
                playlistLimit = selectedPlaylist.limit;
                playlistSort = 'schedule_starts_at';
                buildRequest('getVideos');
                break;
            case 'START_DATE_NEWEST_TO_OLDEST':
                searchString = selectedPlaylist.search;
                playlistLimit = selectedPlaylist.limit;
                playlistSort = encodeURI('-schedule_starts_at');
                buildRequest('getVideos');
                break;
        }
        // undim param input fields
        $aapiParams.setAttribute('style', 'opacity:1;cursor:pointer;');
        $requestSubmitter.setAttribute('style', 'opacity:1;cursor:pointer;');
        buildRequest();
    }

    /**
     * removes spaces from a String
     * @param i{String} str the string to process
     */
    function removeSpaces(str) {
        if (isDefined(str)) {
            str = str.replace(/\s+/g, '');
        return str;
        }
    }

    /**
     * builds the various API requests,
     * submits them,
     * and handles the responses
     * @param {String} type the request type
     */
    function buildRequest(type) {
        var requestOptions = {},
        tmpArray,
        newOption,
        txt,
        frag = new DocumentFragment(),
        currentIndex,
        i;

        // add credentials if submitted
        if (isDefined(client_id) &amp;&amp; isDefined(client_secret)) {
            requestOptions.client_id = client_id;
            requestOptions.client_secret = client_secret;
        }
        switch (type) {
            case 'getPlaylistsCount':
            requestOptions.url = 'https://cms.api.brightcove.com/v1/accounts/' + account_id + '/counts/playlists';
            $request.textContent = requestOptions.url;
            getData(requestOptions, type, function(response) {
                totalPlaylists = response.count;
                buildRequest('getPlaylists');
            });
                break;
            case 'getPlaylists':
            totalPlaylistCalls = Math.ceil(totalPlaylists / limit);
            requestOptions.url = 'https://cms.api.brightcove.com/v1/accounts/' + account_id + '/playlists?limit=' + limit + '&amp;offset=' + (limit * callNumber);
            $request.textContent = requestOptions.url;
            getData(requestOptions, type, function(response) {
                // add the current items array to overall one
                playlistData = playlistData.concat(response);
                callNumber++;
                if (callNumber &lt; totalPlaylistCalls) {
                    // still have more videos to get
                    buildRequest('getPlaylists');
                } else {
                    // build the playlist selector
                    newOption = document.createElement('option');
                    txt = document.createTextNode('Select a Playlist');
                    newOption.appendChild(txt);
                    frag.appendChild(newOption);
                    playlistData.forEach(function(playlist, index, playlistData) {
                        newOption = document.createElement('option');
                        newOption.setAttribute('value', playlist.id);
                        newOption.setAttribute('data-playlist-index', index);
                        txt = document.createTextNode(playlist.name);
                        newOption.appendChild(txt);
                        frag.appendChild(newOption);
                    });
                    // add the options to the playlist selector
                    $playlistSelector.appendChild(frag);
                    // reset callNumber
                    callNumber = 0;
                }
            });
                break;
            case 'getVideos':
                requestOptions.url = 'https://cms.api.brightcove.com/v1/accounts/' + account_id + 'videos?q=' + searchString + '&amp;limit=' + playlistLimit + '&amp;sort=' + playlistSort;
                $request.textContent = requestOptions.url;
                getData(requestOptions, type, function(response) {
                    response.forEach(function(video, index, response) {
                        videoIds.push(video.id);
                    });
                });
                break;
            case 'getAnalytics':
                var formatObj = getSelectedValue($format),
                    format = formatObj.value;
                if (format === 'csv') {
                    isJSON = false;
                }
                requestOptions.url = 'https://analytics.api.brightcove.com/v1/data?accounts=' + account_id + '&amp;dimensions=video&amp;where=video==' + videoIds.join(',') + '&amp;from=' + from.value + '&amp;to=' + to.value + '&amp;limit=all&amp;fields=engagement_score,play_rate,video,video_duration,video_engagement_1,video_engagement_100,video_engagement_25,video_engagement_50,video_engagement_75,video_impression,video_name,video_percent_viewed,video_seconds_viewed,video_view' + '&amp;format=' + format;
                $request.textContent = requestOptions.url;
                getData(requestOptions, type, function(response) {
                    if (format === 'json') {
                        $responseFrame.textContent = JSON.stringify(response, null, '  ');
                    } else {
                        $responseFrame.textContent = response;
                    }
                });
                break;
        }
    }

    /**
     * send API request to the proxy
     * @param  {Object} requestData options for the request
     * @param  {String} requestID the type of request = id of the button
     * @param  {Function} callback the callback function to invoke
     */
    function getData(options, type, callback) {
        var httpRequest = new XMLHttpRequest(),
            parsedData,
            requestParams,
            dataString,
            // response handler
            getResponse = function() {
                try {
                  if (httpRequest.readyState === 4) {
                    if (httpRequest.status &gt;= 200 &amp;&amp; httpRequest.status &lt; 300) {
                        bclslog('responseText', httpRequest.responseText);
                        if (isJSON) {
                            parsedData = JSON.parse(httpRequest.responseText);
                            callback(parsedData);
                        } else {
                            callback(httpRequest.responseText);
                        }
                    } else {
                      alert('There was a problem with the request. Request returned ' + httpRequest.status);
                    }
                  }
                } catch (e) {
                  alert('Caught Exception: ' + e);
                }
            };
            // set up request data
        requestParams = 'url=' + encodeURIComponent(options.url) + '&amp;requestType=GET';
        if (options.client_id &amp;&amp; options.client_secret) {
            requestParams += '&amp;client_id=' + options.client_id + '&amp;client_secret=' + options.client_secret;
        }

        // set response handler
        httpRequest.onreadystatechange = getResponse;
        // open the request
        httpRequest.open('POST', proxyURL);
        // set headers
        httpRequest.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        // open and send request
        httpRequest.send(requestParams);
    }


    // add date pickers to the date input fields
    fromPicker = new Pikaday({
        field: document.getElementById('from'),
        format: 'YYYY-MM-DD',
        onSelect: buildRequest
    });
    toPicker = new Pikaday({
        field: document.getElementById('to'),
        format: 'YYYY-MM-DD',
        onSelect: buildRequest
    });
    // populate to/from fields with default values
    to.value = nowISO;
    from.value = fromISO;

    // set event listeners
    useMyAccount.addEventListener('click', function () {
        bclslog('use account switch');
        if (basicInfo.getAttribute('style') === 'display:none;') {
            basicInfo.setAttribute('style', 'display:block;');
            useMyAccount.textContent = 'Use Sample Account';
        } else {
            basicInfo.setAttribute('style', 'display:none;');
            useMyAccount.textContent = 'Use My Account Instead';
        }
    });

    // event listeners
    $getPlaylists.addEventListener('click', function() {
        if (isDefined($account_id.value)) {
            account_id = $account_id.value;
            if (isDefined($client_id.value) &amp;&amp; isDefined($client_secret.value)) {
                client_id = $client_id.value;
                client_secret = $client_secret.value;
            } else {
                alert('You must provide a client id and secret');
            }
        }
        buildRequest('getPlaylists');
    });

    playlistSelector.addEventListener('change', onPlaylistSelect);

    // send request
    $submitButton.addEventListener('click', function () {
        buildRequest('getAnalytics');
    });

    return {
        onPlaylistSelect : onPlaylistSelect
    };
})(window, document, Pikaday);
</code></pre>

<h3>Proxy</h3>

<aside class="bcls-aside bcls-aside--information">In order to build your own version the sample app on this page, you must create and host your own proxy. (The proxies used by Brightcove Learning Services only accept requests from Brightcove domains.) You can download two versions of our proxy code:
<ul>
	<li><a href="//learning-services-media.brightcove.com/doc-assets/proxy/bcls-proxy-for-distribution.php.zip">This is a general version that expects client credentials to be passed with the request</a></li>
	<li><a href="//learning-services-media.brightcove.com/doc-assets/proxy/doc-samples-proxy.php.zip">This version allows you to save your client credentials in the proxy itself on lines 25-26 (recommended)</a></li>
</ul>
</aside>
</section>
</article>
