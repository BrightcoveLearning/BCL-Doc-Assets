<article class="bcls-article">
<section class="bcls-section">
<h2 id="getCredentials" class="bcls-expander-head">Get credentials</h2>

<div class="bcls-expander-content">
<p>To use the CMS API you will need proper credentials.</p>

<p>The easiest way to get credentials in most cases is through the Studio Admin API Authentication section (requires admin permissions on your account). See <a href="/node/14056">Managing API Authentication Credentials</a> for details. In most cases, you probably just want to get permissions for all CMS API operation:</p>

<figure class="bcls-figure"><img class="bcls-image" alt="CMS API Permissions" src="//learning-services-media.brightcove.com/doc-assets/video-cloud-apis/cms-api/cms-permissions.png" />
<figcaption class="bcls-caption--image">CMS API Permissions</figcaption>
</figure>

<p>If the permissions you need are not available in Studio, or if you prefer to get them directly from the OAuth API, use your choice of the <strong>Get Client Credentials</strong> documents listed below. Whichever option you choose, you will need to ask for the correct operation permissions. The following can be used with cURL or Postman to get all permissions for the CMS API:</p>

<pre class="line-numbers">
  <code class="language-json">"operations": [
    "video-cloud/video/all",
    "video-cloud/playlist/all",
    "video-cloud/sharing-relationships/all",
    "video-cloud/notifications/all"
  ]</code></pre>

<ul>
	<li><a href="/node/17924">OAuth: Get Client Credentials Using cURL</a></li>
	<li><a href="/node/17923">OAuth: Get Client Credentials Using Postman</a></li>
</ul>
</div>
</section>

<section class="bcls-section" id="workingSample">
<h2>Video report generator</h2>

<fieldset class="bcls-fieldset"><legend>Input</legend>

<p>If you do not enter account information, a Brightcove sample account will be used.</p>

<p>Account id: <input id="account_id" type="text" value="" placeholder="1752604059001" /></p>

<p>Client id: <input id="client_id" type="text" size="60" value="" placeholder="c5d0a622-5479-46d8-8d8a-5f034b943fab" /></p>

<p>Client secret: <input id="client_secret" type="text" size="60" value="" placeholder="w7NQYu0vUloM4GYYy2SXAxrvyFpt8fwI35qAFZcS13-VIgs0itwKNsAwHOS80sOWK" /></p>

<p>Optional: retrieve videos with this tag: <input type="text" id="tag" value="" placeholder="foo" style="width:30%;display:inline;" /></p>

<p>Videos to retrieve: <select name="videoCount" id="videoCount"><option value="25">25</option><option value="50">50</option><option value="100">100</option><option value="500">500</option><option value="All">All</option></select></p>

<aside class="bcls-aside bcls-aside--warning">If you select <code>All</code>, be prepared to wait awhile!</aside>

<p><button class="bcls-button" id="makeReport">Generate the Report</button></p>
</fieldset>

<fieldset class="bcls-fieldset"><legend>Log</legend>

<div id="logger" style="color:rgb(237, 104, 38)">
<p id="logText">Waiting for input...</p>
</div>

<p>Current API request</p>

<pre class="line-numbers">
<code id="apiRequest" class="language-http">API request will appear here...</code></pre>
</fieldset>
</section>

<section id="csvDisplay" class="bcls-section">
<h2>CSV Data</h2>

<p>Copy and paste the data below into a an empty text file, and save it with a .csv extension. You can then open the file to view it in your spreadsheet application.</p>
<textarea name="csvData" id="csvData" class="bcls-code" style="height:30em;"></textarea></section>

<section id="code" class="bcls-section">
<h2>Code</h2>

<h3>HTML</h3>

<p>To see the HTML code for this app, view the source for this page.</p>

<h3>JavaScript</h3>

<pre class="line-numbers">
<code class="language-javascript">var BCLS = (function(window, document) {
  var account_id,
    client_id,
    client_secret,
    // api stuff
    proxyURL = 'https://solutions.brightcove.com/bcls/bcls-proxy/doc-samples-proxy-v2.php',
    baseURL = 'https://cms.api.brightcove.com/v1/accounts/',
    limit = 25,
    totalVideos = 0,
    totalCalls = 0,
    callNumber = 0,
    videosCompleted = 0,
    videosArray = [],
    summaryData = {},
    csvStr,
    summaryCsvStr,
    customFields = [],
    // elements
    account_id_element = document.getElementById('account_id'),
    client_id_element = document.getElementById('client_id'),
    client_secret_element = document.getElementById('client_secret'),
    tag = document.getElementById('tag'),
    videoCount = document.getElementById('videoCount'),
    makeReport = document.getElementById('makeReport'),
    content,
    logger = document.getElementById('logger'),
    logText = document.getElementById('logText'),
    csvData = document.getElementById('csvData'),
    apiRequest = document.getElementById('apiRequest'),
    allButtons = document.getElementsByName('button'),
    pLogGettingVideos = document.createElement('p'),
    pLogGettingRenditions = document.createElement('p'),
    pLogFinish = document.createElement('p'),
    spanIntro2 = document.createElement('span'),
    spanOf2 = document.createElement('span'),
    spanRenditionsTotal = document.createElement('span'),
    spanRenditionsCount = document.createElement('span'),
    spanRenditionsTotalEl,
    spanRenditionsCountEl;

  /**
   * tests for all the ways a variable might be undefined or not have a value
   * @param {String|Number} x the variable to test
   * @return {Boolean} true if variable is defined and has a value
   */
  function isDefined(x) {
    if (x === '' || x === null || x === undefined) {
      return false;
    }
    return true;
  }

  /*
   * tests to see if a string is json
   * @param {String} str string to test
   * @return {Boolean}
   */
  function isJson(str) {
      try {
          JSON.parse(str);
      } catch (e) {
          return false;
      }
      return true;
  }

  /**
   * get selected value for single select element
   * @param {htmlElement} e the select element
   */
  function getSelectedValue(e) {
    return e.options[e.selectedIndex].value;
  }

  /**
   * disables all buttons so user can't submit new request until current one finishes
   */
  function disableButtons() {
    var i,
      iMax = allButtons.length;
    for (i = 0; i &lt; iMax; i++) {
      allButtons[i].setAttribute('disabled', 'disabled');
    }
  }

  /**
   * re-enables all buttons
   */
  function enableButtons() {
    var i,
      iMax = allButtons.length;
    for (i = 0; i &lt; iMax; i++) {
      allButtons[i].removeAttribute('disabled');
    }
  }

  /**
   * sort an array of objects based on an object property
   * @param {array} targetArray - array to be sorted
   * @param {string|number} objProperty - object property to sort on
   * @return sorted array
   */
  function sortArray(targetArray, objProperty) {
    targetArray.sort(function(a, b) {
      var propA = a[objProperty],
        propB = b[objProperty];
      // sort ascending; reverse propA and propB to sort descending
      if (propA &lt; propB) {
        return -1;
      } else if (propA &gt; propB) {
        return 1;
      } else {
        return 0;
      }
    });
    return targetArray;
  }

  function processRenditions(renditions, callback) {
    var i,
      iMax = renditions.length,
      hlsRenditions = [],
      mp4Renditions = [],
      flvRenditions = [],
      otherRenditions = [],
      totalSize = 0;
    // separate renditions by type
    for (i = 0; i &lt; iMax; i += 1) {
      if (renditions[i].hasOwnProperty('size')) {
        totalSize += renditions[i].size;
      }
      if (renditions[i].video_container === 'M2TS') {
        hlsRenditions.push(renditions[i]);
      } else if (renditions[i].video_container === 'MP4') {
        mp4Renditions.push(renditions[i]);
      } else if (renditions[i].video_container === 'FLV') {
        flvRenditions.push(renditions[i]);
      } else {
        otherRenditions.push(renditions[i]);
      }
    }
    // sort renditions by encoding rate
    callback(hlsRenditions, mp4Renditions, flvRenditions, otherRenditions, totalSize);
  }

  /**
   * determines whether specified item is in an array
   *
   * @param {array} array to check
   * @param {string} item to check for
   * @return {boolean} true if item is in the array, else false
   */
  function arrayContains(arr, item) {
    var i,
      iMax = arr.length;
    for (i = 0; i &lt; iMax; i++) {
      if (arr[i] === item) {
        return true;
      }
    }
    return false;
  }

  function processCustomFields(fields) {
    var field;
    for (field in fields) {
      if (!arrayContains(customFields, field)) {
        customFields.push(field);
      }
    }
  }


  function startCSVStrings() {
    var i = 0,
      iMax;
    csvStr = '"ID","Name","Reference ID","Description","Date Added","Date Last Modified","Filename","Resolution","Duration(sec)","HLS Renditions (bitrate range KBPS)","MP4 Renditions (bitrate range KBPS)","FLV Renditions (bitrate range KBPS)","Total Rendition Size (MB)",';
    if (customFields) {
      iMax = customFields.length;
      for (i; i &lt; iMax; i++) {
        csvStr += '"' + customFields[i] + '",';
      }
    }
    csvStr += '\r\n';
  }

  function writeReport() {
    var i,
      iMax,
      j,
      jMax,
      video,
      hlsLowRate,
      hlsHighRate,
      mp4LowRate,
      mp4HighRate,
      flvLowRate,
      flvHighRate,
      resWidth,
      resHeight,
      rendition = {};
    if (videosArray.length &gt; 0) {
      iMax = videosArray.length;
      for (i = 0; i &lt; iMax; i += 1) {
        video = videosArray[i];
        // replace any line breaks in description, as that will break the CSV
        if (video.description) {
          video.description = video.description.replace(/(?:\r\n|\r|\n)/g, ' ');
        }
        // generate the video detail row
        hlsLowRate = (video.hlsRenditions.length &gt; 0) ? video.hlsRenditions[0].encoding_rate / 1000 : 0;
        hlsHighRate = (video.hlsRenditions.length &gt; 0) ? video.hlsRenditions[video.hlsRenditions.length - 1].encoding_rate / 1000 : 0;
        mp4LowRate = (video.mp4Renditions.length &gt; 0) ? video.mp4Renditions[0].encoding_rate / 1000 : 0;
        mp4HighRate = (video.mp4Renditions.length &gt; 0) ? video.mp4Renditions[video.mp4Renditions.length - 1].encoding_rate / 1000 : 0;
        flvLowRate = (video.flvRenditions.length &gt; 0) ? video.flvRenditions[0].encoding_rate / 1000 : 0;
        flvHighRate = (video.flvRenditions.length &gt; 0) ? video.flvRenditions[video.flvRenditions.length - 1].encoding_rate / 1000 : 0;
        if (video.flvRenditions.length &gt; 0) {
          rendition = video.flvRenditions[video.flvRenditions.length - 1];
        } else if (video.mp4Renditions.length &gt; 0) {
          rendition = video.mp4Renditions[video.mp4Renditions.length - 1];
        } else if (video.hlsRenditions.length &gt; 0) {
          rendition = video.hlsRenditions[video.hlsRenditions.length - 1];
        } else {
          rendition.frame_width = "unknown";
          rendition.frame_height = "unknown";
        }
        resWidth = rendition.frame_width;
        resHeight = rendition.frame_height;
        // add csv row
        csvStr += '"' + video.id + '","' + video.name + '","' + video.reference_id + '","' + video.description + '","' + video.created_at + '","' + video.updated_at + '","' + video.original_filename + '","' + resWidth + 'x' + resHeight + '","' + video.duration / 1000 + '","' + video.hlsRenditions.length + ' (' + hlsLowRate + '-' + hlsHighRate + ')","' + video.mp4Renditions.length + ' (' + mp4LowRate + '-' + mp4HighRate + ')","' + video.flvRenditions.length + ' (' + flvLowRate + '-' + flvHighRate + ')",' + '"' + (video.totalSize / 1000000) + '",';
        if (customFields) {
          jMax = customFields.length;
          for (j = 0; j &lt; jMax; j++) {
            if (video.custom_fields.hasOwnProperty(customFields[j])) {
              csvStr += '"' + video.custom_fields[customFields[j]] + '",';
            } else {
              csvStr += '"",';
            }
          }
          csvStr += '\r\n';
        } else {
          csvStr += '\r\n';
        }
      }
      csvData.textContent += csvStr;
      // content = document.createTextNode('Finished! See the results or get the CSV data below.');
      pLogFinish.textContent = 'Finished! See the results or get the CSV data below.';
      // reportDisplay.innerHTML = summaryReportStr + reportStr;
      enableButtons();
    }
  }

  /**
   * sets up the data for the API request
   * @param {String} id the id of the button that was clicked
   */
  function createRequest(id) {
    var endPoint = '',
      parsedData,
      options = {};
      options.proxyURL = proxyURL;
      if (isDefined(client_id) &amp;&amp; isDefined(client_secret)) {
        options.client_id = client_id;
        options.client_secret = client_secret;
      }
    // disable buttons to prevent a new request before current one finishes
    disableButtons();
    switch (id) {
      case 'getCount':
        endPoint = account_id + '/counts/videos?sort=created_at';
        if (isDefined(tag.value)) {
          endPoint += '&amp;q=%2Btags:' + tag.value;
        }
        options.url = baseURL + endPoint;
        options.requestType = 'GET';
        apiRequest.textContent = options.url;
        makeRequest(options, function(response) {
          parsedData = JSON.parse(response);
          // set total videos
          videoCount = parsedData.count;
          if (totalVideos === "All") {
            totalVideos = videoCount;
          } else {
            totalVideos = (totalVideos &lt; videoCount) ? totalVideos : videoCount;
          }
          totalCalls = Math.ceil(totalVideos / limit);
          logText.textContent = totalVideos + ' videos found; getting account custom fields';
          createRequest('getCustomFields');
        });
        break;
      case 'getCustomFields':
        endPoint = account_id + '/video_fields';
        options.url = baseURL + endPoint;
        options.requestType = 'GET';
        apiRequest.textContent = options.url;
        makeRequest(options, function(response) {
          parsedData = JSON.parse(response);
          for (field in parsedData.custom_fields) {
            customFields.push(field);
          }
          logText.textContent = 'Custom fields retrieved; getting videos...';
          spanRenditionsTotalEl.textContent = totalVideos;
          createRequest('getVideos');
        });
        break;
      case 'getVideos':
        var offset = (limit * callNumber);
        endPoint = account_id + '/videos?sort=created_at&amp;limit=' + limit + '&amp;offset=' + offset;
        if (isDefined(tag.value)) {
          endPoint += '&amp;q=%2Btags:' + tag.value;
        }
        options.url = baseURL + endPoint;
        options.requestType = 'GET';
        apiRequest.textContent = options.url;
        makeRequest(options, function(response) {
          parsedData = JSON.parse(response);
          videosArray = videosArray.concat(parsedData);
          callNumber++;
          if (callNumber &lt; totalCalls) {
            createRequest('getVideos');
          } else {
            callNumber = 0;
            spanRenditionsCountEl.textContent = callNumber + 1;
            spanRenditionsTotalEl.textContent = totalVideos;
            createRequest('getDigitalMaster');
          }
        });
        break;
      case 'getDigitalMaster':
        videosArray[callNumber].totalSize = 0;
        endPoint = account_id + '/videos/' + videosArray[callNumber].id + '/digital_master';
        options.url = baseURL + endPoint;
        options.requestType = 'GET';
        apiRequest.textContent = options.url;
        makeRequest(options, function(response) {
            responseDecoded = JSON.parse(response);
            if (isDefined(responseDecoded) &amp;&amp; !isDefined(responseDecoded.length)) {
            videosArray[callNumber].totalSize += responseDecoded.size;
            createRequest('getVideoRenditions');
          } else {
            createRequest('getVideoRenditions');
          }
        })
        break;
      case 'getVideoRenditions':
        var i,
          iMax = videosArray.length;
        videosArray[callNumber].hlsRenditions = [];
        videosArray[callNumber].mp4Renditions = [];
        videosArray[callNumber].flvRenditions = [];
        videosArray[callNumber].otherRenditions = [];
        endPoint = account_id + '/videos/' + videosArray[callNumber].id + '/assets/renditions';
        options.url = baseURL + endPoint;
        options.requestType = 'GET';
        apiRequest.textContent = options.url;
        spanRenditionsCountEl.textContent = callNumber + 1;
        makeRequest(options, function(response) {
            var renditions = JSON.parse(response);
            if (renditions.length &gt; 0) {
              processRenditions(renditions, function(hlsRenditions, mp4Renditions, flvRenditions, otherRenditions, totalSize) {
                if (hlsRenditions.length &gt; 0) {
                  sortArray(hlsRenditions, 'encoding_rate');
                }

                videosArray[callNumber].hlsRenditions = hlsRenditions;
                if (mp4Renditions.length &gt; 0) {
                  sortArray(mp4Renditions, 'encoding_rate');
                }
                videosArray[callNumber].mp4Renditions = mp4Renditions;
                if (flvRenditions.length &gt; 0) {
                  sortArray(flvRenditions, 'encoding_rate');
                }
                videosArray[callNumber].flvRenditions = flvRenditions;
                // if (otherRenditions.length &gt; 0) {
                //     sortArray(otherRenditions, 'encoding_rate');
                // }
                // videosArray[callNumber].otherRenditions = otherRenditions;
                videosArray[callNumber].totalSize += totalSize;
            });
          } else {
              videosArray[callNumber].hlsRenditions = [];
              videosArray[callNumber].mp4Renditions = [];
              videosArray[callNumber].flvRenditions = [];
            }
          videosCompleted++;
          logText.textContent = totalVideos + ' videos found; videos retrieved: ' + videosCompleted;
          callNumber++;
          if (callNumber &lt; totalVideos) {
            createRequest('getDigitalMaster');
          } else {
            // create csv headings
            startCSVStrings();
            // write the report
            writeReport();
          }
        });
        break;
    }
  }

  /**
   * send API request to the proxy
   * @param  {Object} options for the request
   * @param  {String} options.url the full API request URL
   * @param  {String="GET","POST","PATCH","PUT","DELETE"} requestData [options.requestType="GET"] HTTP type for the request
   * @param  {String} options.proxyURL proxyURL to send the request to
   * @param  {String} options.client_id client id for the account (default is in the proxy)
   * @param  {String} options.client_secret client secret for the account (default is in the proxy)
   * @param  {JSON} [options.requestBody] Data to be sent in the request body in the form of a JSON string
   * @param  {Function} [callback] callback function that will process the response
   */
  function makeRequest(options, callback) {
      var httpRequest = new XMLHttpRequest(),
          response,
          requestParams,
          dataString,
          proxyURL    = options.proxyURL,
          // response handler
          getResponse = function() {
              try {
                  if (httpRequest.readyState === 4) {
                      if (httpRequest.status &gt;= 200 &amp;&amp; httpRequest.status &lt; 300) {
                          response = httpRequest.responseText;
                          // some API requests return '{null}' for empty responses - breaks JSON.parse
                          if (response === '{null}') {
                              response = null;
                          }
                          // return the response
                          callback(response);
                      } else {
                          alert('There was a problem with the request. Request returned ' + httpRequest.status);
                      }
                  }
              } catch (e) {
                  alert('Caught Exception: ' + e);
              }
          };
      /**
       * set up request data
       * the proxy used here takes the following request body:
       * JSON.strinify(options)
       */
      // set response handler
      httpRequest.onreadystatechange = getResponse;
      // open the request
      httpRequest.open('POST', proxyURL);
      // open and send request
      httpRequest.send(JSON.stringify(options));
  }


  function init() {
    // event listeners
    csvData.addEventListener('click', function() {
      this.select();
    });
    // set up the log elements
    content = document.createTextNode('Getting renditions for video ');
    spanIntro2.appendChild(content);
    content = document.createTextNode(' of ');
    spanOf2.appendChild(content);
    spanRenditionsCount.setAttribute('id', 'spanRenditionsCount');
    spanRenditionsTotal.setAttribute('id', 'spanRenditionsTotal');
    pLogGettingRenditions.appendChild(spanIntro2);
    pLogGettingRenditions.appendChild(spanRenditionsCount);
    pLogGettingRenditions.appendChild(spanOf2);
    pLogGettingRenditions.appendChild(spanRenditionsTotal);
    logger.appendChild(pLogGettingRenditions);
    spanRenditionsCountEl = document.getElementById('spanRenditionsCount');
    spanRenditionsTotalEl = document.getElementById('spanRenditionsTotal');
    logger.appendChild(pLogFinish);

  }

  // button event handlers
  makeReport.addEventListener('click', function() {
    // get the inputs
    client_id = client_id_element.value;
    client_secret = client_secret_element.value;
    account_id = account_id_element.value
    totalVideos = getSelectedValue(videoCount);
    // only use entered account id if client id and secret are entered also
    if (!isDefined(client_id) || !isDefined(client_secret) || !isDefined(account_id)) {
      window.alert('To use your own account, you must specify an account id, and client id, and a client secret - since at least one of these is missing, a sample account will be used');
        account_id = '1752604059001';
    }
    // get video count
    createRequest('getCount');

  });

  init();
})(window, document);
</code></pre>

<h3>Proxy</h3>

<aside class="bcls-aside bcls-aside--information">In order to build your own version the sample app on this page, you must create and host your own proxy. (The proxies used by Brightcove Learning Services only accept requests from Brightcove domains.) You can download two versions of our proxy code:
<ul>
	<li><a href="//learning-services-media.brightcove.com/doc-assets/proxy/bcls-proxy-for-distribution.php.zip">This is a general version that expects client credentials to be passed with the request</a></li>
	<li><a href="//learning-services-media.brightcove.com/doc-assets/proxy/doc-samples-proxy.php.zip">This version allows you to save your client credentials in the proxy itself on lines 25-26 (recommended)</a></li>
</ul>
</aside>
</section>
</article>
<script src="//learning-services-media.brightcove.com/doc-assets/node/18032-video-report-generator/video-report.js"></script>
