<article class="bcls-article">
  <section class="bcls-section">
    <h2 id="Overview">Overview</h2>
    <figure class="bcls-figure">
      <img src="https://learning-services-media.brightcove.com/doc-assets/node/18697-quick-start-using-rtmp-outputs-live-events/block-diagram-small-small.png" alt="general-block-diagram" title="Block diagram">
      <figcaption class="bcls-caption--image">Block Diagram</figcaption>
    </figure>
    <p>This tutorial explains at the API level how to create a live streaming job in <a href="/node/19642">Brightcove live</a> and then create a frame-accurate clip from it.</p>
    <p>Note that frame-accurate clipping requires that your encoder be sending SMPTE timecodes.</p>
    <p>This tutorial will use <a href="/node/17908" class="notranslate">curl</a> to make the API requests, but you can easily make them in <a href="/node/18462" class="notranslate">Insomnia</a>, <a href="/node/17919" class="notranslate">Postman</a> or other REST clients instead.</p>
  </section>
  <section class="bcls-section">
    <h2 id="create_a_live_job">Create a live job</h2>
    <p>First, we will create a live job. You will need an <code>API-KEY</code> for the Live API. If you do not, and are interested in obtaining access, please contact your account manager.</p>
    <ol class="bcls-tasklist">
      <li>We assume you already have a brightcove acount and they you have your API-KEY, let's call it <code>bcov-live-api-key</code></li>
      <li>
        <p>Copy and paste the following <span class="notranslate">curl</span> command into a text editor:</p>
<pre class="line-numbers"><code class="language-bash">curl -X POST \
  https://api.bcovlive.io/v1/jobs \
  -H 'Content-Type: application/json' \
  -H 'x-api-key: {{bcov-live-api-key}}' \
  -d '{
    "live_stream": true,
    "region": "{{closest-region-encoder}}",
    "outputs": [{
      "label": "hls360p",
      "live_stream": true,
      "height": 360,
      "video_bitrate": 365,
      "segment_seconds": 6,
      "keyframe_interval": 60
    },
    {
      "label": "hls432p",
      "live_stream": true,
      "height": 432,
      "video_bitrate": 730,
      "segment_seconds": 6,
      "keyframe_interval": 60
    },
    {
      "label": "hls540p",
      "live_stream": true,
      "height": 540,
      "video_bitrate": 2000,
      "segment_seconds": 6,
      "keyframe_interval": 60
    },
    {
      "label": "hls720p3M",
      "live_stream": true,
      "height": 540,
      "video_bitrate": 2000,
      "segment_seconds": 6,
      "keyframe_interval": 60
    },
    {
      "label": "hls720p4.5M",
      "live_stream": true,
      "height": 540,
      "video_bitrate": 4500,
      "segment_seconds": 6,
      "keyframe_interval": 60
    }]
  }'
</code></pre>
      </li>
      <li>
        <p><strong>Replace:</strong></p>
        <ul>
          <li><code>{{closest-region-encoder}}</code> with the closest available region to your encoder, see <a href="/node/17764#Support_aws_regions">closest available regions</a> to your encoder. For instance: <code>us-west-2</code></li>
          <li><code>{{bcov-live-api-key}}</code> with your Brightcove live API key. For example: <code>abcdfeg-this-is-a-fake-api-key-FgJajjasd12hJHsZ</code></li>
        </ul>
      </li>
      <li>After making those changes, copy and paste the code into Terminal or whatever command-line app you use and run it.</li>
      <li>
        <p>The response should be something like this:</p>
<pre class="line-numbers"><code class="language-json">{
    "id": "3b6871bf2f344acaa6b397d09b476018",
    "outputs": [... removed for simplicity ...],
    "stream_url": "rtmp://ep1-usw2.bcovlive.io:1935/3b6871bf2f344acaa6b397d09b476018",
    "stream_name": "alive",
    "static": false,
    "encryption": {},
    "playback_url": "https://bcovlive-a.akamaihd.net/3b6871bf2f344acaa6b397d09b476018/us-west-2/NA/playlist.m3u8",
    "playback_url_dvr": "https://bcovlive-a.akamaihd.net/3b6871bf2f344acaa6b397d09b476018/us-west-2/NA/playlist_dvr.m3u8"
}</code></pre>
      </li>
    </ol>
    <p>This jobs will create 5 renditions <strong>based</strong> on <a href="https://developer.apple.com/documentation/http_live_streaming/hls_authoring_specification_for_apple_devices">Apple recommendations</a>.</p>
  </section>
  <section class="bcls-section">
    <h2 id="Configure_your_encoder">Configure your encoder</h2>
    <p>The steps shown here will assume an <a href="https://www.elemental.com/products/aws-elemental-live">Elemental live box</a> encoder, which was used in testing the steps for this tutorial. If you have a different encoder, the settings should be similar.</p>
    <p>The most important settings for this case are:</p>
    <ul>
      <li>Configure timecode source as "system clock"</li>
      <li>Set "OnFi timecode frequency" to 1</li>
      <li>Check "time code insertion" inside video</li>
      <li>Strongly recommended: Framerate = follow source</li>
    </ul>
    <p>This is the config we used for this experiment:</p>
    <figure class="bcls-figure">
      <img src="https://learning-services-media.brightcove.com/doc-assets/node/18697-quick-start-using-rtmp-outputs-live-events/elemental-live-job-config-v1-small.png" alt="elemental-live-job-config" title="Elemental live config">
      <figcaption class="bcls-caption--image">Elemental live config</figcaption>
    </figure>
  </section>
  <section class="bcls-section">
    <h2 id="test_playback">Test playback</h2>
    <p>You can use this <a href="https://videojs.github.io/videojs-contrib-hls/">VideoJS HLS demo page</a> to test playback, just paste the value <code>playback_url</code> returned in the creation job response:</p>
    <figure class="bcls-figure">
      <img src="https://learning-services-media.brightcove.com/doc-assets/node/18697-quick-start-using-rtmp-outputs-live-events/videojs-hls-playback-small.png" alt="videojs-hls-playback" title="VideoJS HLS playback demo page">
      <figcaption class="bcls-caption--image">VideoJS HLS playback demo page</figcaption>
    </figure>
  </section>

  <section class="bcls-section">
    <h2 id="create_clip">Create a frame-accurate clip</h2>
    <p>In this tutorial, we will assume that you are sending the clip to your Video Cloud library. If you are sending the clip to an S3 bucket or some other location, the process is the same - there are just some minor differences in the request body for the API requests.</p>
    <section class="bcls-subsection">
      <h3 id="video-cloud-credentials">Credentials</h3>
      <p>If you have not created credentials for Video Cloud in your Live account, you can follow the steps here to do so. This is a one-time operation.</p>
      <p>If you do not yet have client credentials for Dynamic Ingest of videos to Video Cloud, you will need to create them. See <a href="/node/14056">Managing API Authentication Credentials</a> for instructions on how to do this in Studio.</p>
      <ol class="bcls-tasklist">
      <li>
        Copy the curl command below into a text editor:
<pre class="line-numbers"><code class="language-bash"><pre><code>curl -X POST \
  https://api.bcovlive.io/v1/credentials \
  -H 'Content-Type: application/json' \
  -H 'x-api-key: {{bcov-live-api-key}}' \
  -d '{
  "credential_default_for_type": true,
  "credential_label": "Video_Cloud_Uploads",
  "credential_private": "{{client_secret}}",
  "credential_public": "{{client_id}}",
  "credential_type": "videocloud"
}'
</code></pre></code></pre>
      </li>
      <li>
        <p><strong>Replace:</strong></p>
        <ul>
          <li><code>{{bcov-live-api-key}}</code> with your Live API key</li>
          <li><code>{{client_secret}}</code> with your client secret</li>
          <li><code>{{client_id}}</code> with your client id</li>
        </ul>
      </li>
      <li>Copy and paste the edited command into Terminal or your command line app, and run it.</li>
      <li>
        The response should look similar to this:
<pre class="line-numbers"><code class="language-json">{
  "credential_id": "1e0180330b724dfbbcaf6b28b6c5d517",
  "user_id": "c2691d4d039040be96c190a949d754a7",
  "credential_label": "Video_Cloud_Uploads"
}</code></pre>
      </li>
      </ol>
    </section>
  </section>
</article>

<ul>
<li>Create the destination S3 bucket and configure the credentials (you just need to to that once):
<ul>
<li>Create an S3 bucket and a AWS IAM user with write rights to that bucket, see <a href="https://docs.aws.amazon.com/quickstarts/latest/s3backup/step-1-create-bucket.html">create s3 bucket</a>, <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html">create IAM user</a>, <a href="https://aws.amazon.com/premiumsupport/knowledge-center/iam-s3-user-specific-folder/">set IAM user rights to access S3 folders</a></li>
<li>Get AWS access ID and SECRET for that user and add those as s3 credential to Brighcove live with the following command:</li>
</ul>
</li>
</ul>
<pre><code>curl -X POST \
  https://api.bcovlive.io/v1/credentials \
  -H 'Content-Type: application/json' \
  -H 'x-api-key: {{bcov-live-api-key}}' \
  -d '{
  "credential_default_for_type": false,
  "credential_label": "AWS-TEST-S3-UPLOADS",
  "credential_private": "{{aws-iam-user-id}}",
  "credential_public": "{{aws-iam-user-secret}}",
  "credential_type": "s3"
}'
</code></pre>
<p><strong>Replace:</strong></p>
<ul>
<li><code>{{bcov-live-api-key}}</code> for your Brightcove live API key. For instance: <code>abcdfeg-this-is-a-fake-api-key-FgJajjasd12hJHsZ</code></li>
<li><code>{{aws-iam-user-id}}</code> and <code>{{aws-iam-user-secret}}</code> for the values provided by AWS</li>
</ul>
<p>The response should be something like this:</p>
<pre><code>{"credential_id":"296f44cb4fb54ef7a828ba0a60512cd2","user_id":"666f23e01f57441890650a97dc189301","credential_label":"AWS-TEST-S3-UPLOADS"}
</code></pre>
<ul>
<li>Create the following request that will create the clip and upload it to your S3 bucket:</li>
</ul>
<pre><code>curl -X POST \
  https://api.bcovlive.io/v1/vods \
  -H 'Content-Type: application/json' \
  -H 'x-api-key: {{bcov-live-api-key}}' \
  -d '{
    "live_job_id":"{{bcov-live-job-id}}",
    "outputs":[{
        "label": "Trim by SMPTE TC 17:33:11:12 to 17:34:00:00",
    	"stream_start_timecode": "{{timecode-in}}",
    	"stream_end_timecode": "{{timecode-out}}",
        "url":"s3://jordi-test/clipping-test/smpte_tc_1542910526.mp4",
        "credentials": "AWS-TEST-S3-UPLOADS"
    }]
}'
</code></pre>
<p><strong>Replace:</strong></p>
<ul>
<li><code>{{bcov-live-api-key}}</code> for your Brightcove live API key. For instance: <code>abcdfeg-this-is-a-fake-api-key-FgJajjasd12hJHsZ</code></li>
<li><code>{{bcov-live-job-id}}</code> for your Brightcove live API key. In out example this value should be <code>3b6871bf2f344acaa6b397d09b476018</code></li>
<li><code>{{timecode-in}}</code> and <code>{{timecode-out}}</code> should be values that make sense (present) in your live stream. In our example we have used: <code>17:33:11:12</code> and <code>17:34:00:00</code></li>
</ul>
<p>The response should be something like this:</p>
<pre><code>{
    "vod_jobs": [
        {
            "jvod_id": "0b14a4ba326d4dd08f15053ca2a403b7",
            "label": "Trim by SMPTE TC 17:33:11:12 to 17:34:00:00"
        }
    ],
    "live_job_id": "3b6871bf2f344acaa6b397d09b476018"
}
</code></pre>
<ul>
<li>To test the accuracy of the experiment we downloaded the clip and used <a href="https://www.adobe.com/products/premiere.html">Adobe premiere</a> to checked the 1st and last frame, since the timecode is overlayed a simple visual check is enough to confirm the accuracy at input and output points:
<img src="https://learning-services-media.brightcove.com/doc-assets/node/18697-quick-start-using-rtmp-outputs-live-events/clip-accuracy-in-small.png" alt="clip-accuracy-in" title="Visual clip accuracy test - in">
<img src="https://learning-services-media.brightcove.com/doc-assets/node/18697-quick-start-using-rtmp-outputs-live-events/clip-accuracy-out-small.png" alt="clip-accuracy-out" title="Visual clip accuracy test - out"></li>
</ul>
<p>Note: We can use <a href="https://aws.amazon.com/lambda/">AWS lambdas</a> and <a href="https://aws.amazon.com/step-functions/">AWS Lambdas step functions</a> to automate any kind of VOD publishing process based on the event trigered by S3 PUT.</p>
<h1>References</h1>
<ul>
<li><a href="https://docs.brightcove.com/live-api/v1/doc/index.html">Brightcove live API reference</a></li>
</ul>
<h1>TODOs</h1>
<ul>
<li>Add <a href="https://www.srtalliance.org/about-github/">SRT</a> as ingest option.  <em>Remember SRT is based on UDP bidirectional communication</em>, your firewall / router needs to be configured properly and allow UDP outputs from the encoder's IP (caller) and UDP back from the internet on the same port</li>
<li>Add TS+FEC as ingest option. <em>This communications is based on UDP unidirectional communication (encoder to live platform)</em>, your firewall / router needs to be configured properly and allow UDP outputs from the encoder to the internet from the encoder's IP.</li>
</ul>
