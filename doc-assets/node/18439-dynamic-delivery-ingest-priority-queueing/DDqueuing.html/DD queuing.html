
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <!-- common.css -->
      <style>* {-webkit-tap-highlight-color: rgba(0,0,0,0);}html {-webkit-text-size-adjust: none;}body {font-family: -apple-system, Helvetica, Arial, sans-serif;margin: 0;padding: 20px;color: #333;word-wrap: break-word;}h1, h2, h3, h4, h5, h6 {line-height: 1.1;}img {max-width: 100% !important;height: auto;}blockquote {margin: 0;padding: 0 15px;color: #777;border-left: 4px solid #ddd;}hr {background-color: #ddd;border: 0;height: 1px;margin: 15px 0;}code {font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, 'source-code-pro', monospace;line-height: 1.4;margin: 0;padding: 0.2em 0;font-size: 90%;background-color: rgba(0,0,0,0.04);border-radius: 3px;}pre > code {margin: 0;padding: 0;font-size: 100%;word-break: normal;background: transparent;border: 0;}ol {list-style-type: decimal;}ol ol, ul ol {list-style-type: lower-latin;}ol ol ol, ul ol ol, ul ul ol, ol ul ol {list-style-type: lower-roman;}table {border-spacing: 0;border-collapse: collapse;margin-top: 0;margin-bottom: 16px;}table th {font-weight: bold;}table th, table td {padding: 6px 13px;border: 1px solid #ddd;}table tr {border-top: 1px solid #ccc;}table tr:nth-child(even) {background-color: #f8f8f8;}input[type="checkbox"] {cursor: default;margin-right: 0.5em;font-size: 13px;}.task-list-item {list-style-type: none;}.task-list-item+.task-list-item {margin-top: 3px;}.task-list-item input {float: left;margin: 0.3em 1em 0.25em -1.6em;vertical-align: middle;}#tag-field {margin: 8px 2px 10px;}#tag-field .tag {display: inline-block;background: #cadff3;border-radius: 4px;padding: 1px 8px;color: black;font-size: 12px;margin-right: 10px;line-height: 1.4;}</style>
      <!-- ace-static.css -->
      <style>.ace_static_highlight {white-space: pre-wrap;}.ace_static_highlight .ace_gutter {width: 2em;text-align: right;padding: 0 3px 0 0;margin-right: 3px;}.ace_static_highlight.ace_show_gutter > .ace_line {padding-left: 2.6em;}.ace_static_highlight .ace_line {position: relative;}.ace_static_highlight .ace_gutter-cell {-moz-user-select: -moz-none;-khtml-user-select: none;-webkit-user-select: none;user-select: none;top: 0;bottom: 0;left: 0;position: absolute;}.ace_static_highlight .ace_gutter-cell:before {content: counter(ace_line, decimal);counter-increment: ace_line;}.ace_static_highlight {counter-reset: ace_line;}</style>
      <style>.ace-solarized-dark .ace_gutter {background: #01313f;color: #d0edf7}.ace-solarized-dark .ace_print-margin {width: 1px;background: #33555E}.ace-solarized-dark {background-color: #002B36;color: #93A1A1}.ace-solarized-dark .ace_entity.ace_other.ace_attribute-name,.ace-solarized-dark .ace_storage {color: #93A1A1}.ace-solarized-dark .ace_cursor,.ace-solarized-dark .ace_string.ace_regexp {color: #D30102}.ace-solarized-dark .ace_marker-layer .ace_active-line,.ace-solarized-dark .ace_marker-layer .ace_selection {background: rgba(255, 255, 255, 0.1)}.ace-solarized-dark.ace_multiselect .ace_selection.ace_start {box-shadow: 0 0 3px 0px #002B36;}.ace-solarized-dark .ace_marker-layer .ace_step {background: rgb(102, 82, 0)}.ace-solarized-dark .ace_marker-layer .ace_bracket {margin: -1px 0 0 -1px;border: 1px solid rgba(147, 161, 161, 0.50)}.ace-solarized-dark .ace_gutter-active-line {background-color: #0d3440}.ace-solarized-dark .ace_marker-layer .ace_selected-word {border: 1px solid #073642}.ace-solarized-dark .ace_invisible {color: rgba(147, 161, 161, 0.50)}.ace-solarized-dark .ace_keyword,.ace-solarized-dark .ace_meta,.ace-solarized-dark .ace_support.ace_class,.ace-solarized-dark .ace_support.ace_type {color: #859900}.ace-solarized-dark .ace_constant.ace_character,.ace-solarized-dark .ace_constant.ace_other {color: #CB4B16}.ace-solarized-dark .ace_constant.ace_language {color: #B58900}.ace-solarized-dark .ace_constant.ace_numeric {color: #D33682}.ace-solarized-dark .ace_fold {background-color: #268BD2;border-color: #93A1A1}.ace-solarized-dark .ace_entity.ace_name.ace_function,.ace-solarized-dark .ace_entity.ace_name.ace_tag,.ace-solarized-dark .ace_support.ace_function,.ace-solarized-dark .ace_variable,.ace-solarized-dark .ace_variable.ace_language {color: #268BD2}.ace-solarized-dark .ace_string {color: #2AA198}.ace-solarized-dark .ace_comment {font-style: italic;color: #657B83}.ace-solarized-dark .ace_indent-guide {background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAACCAYAAACZgbYnAAAAEklEQVQImWNg0Db1ZVCxc/sPAAd4AlUHlLenAAAAAElFTkSuQmCC) right repeat-y}</style>
      <!-- export.css -->
      <style>
        body{margin:0 auto;max-width:800px;line-height:1.4}
        #nav{margin:5px 0 10px;font-size:15px}
        #titlearea{border-bottom:1px solid #ccc;font-size:17px;padding:10px 0;}
        #contentarea{font-size:15px;margin:16px 0}
        .cell{outline:0;min-height:20px;margin:5px 0;padding:5px 0;}
        .code-cell{font-family:Menlo,Consolas,'Ubuntu Mono',Monaco,'source-code-pro',monospace;font-size:12px;}
        .latex-cell{white-space:pre-wrap;}
      </style>
      <!-- User CSS -->
      <style> .text-cell {font-size: 15px;}.code-cell {font-size: 12px;}.markdown-cell {font-size: 15px;}.latex-cell {font-size: 15px;}</style>
    </head>
    <body>
      
      <div id="titlearea">
        <h2>DD queuing</h2>
      </div>
      <div id="contentarea"><div class="cell markdown-cell"><h1>Bolt Ingest "Priority Queueing"</h1>
<p>Bolt Ingest now has a feature called "Priority Queueing" that allow publishers to submit ingest jobs to us with<br>
a desired priority setting to influence the order and timeliness of when the job will be processed.</p>
<p>This document ONLY covers BOLT ingestion.  Nothing said here should be assumed applicable to Mannheim based<br>
ingestion (or any other ingestion system we have.)</p>
<h2>Brief comments about Ingestion job submission and queueing</h2>
<p>Bolt Ingestion has a limit on the amount of work a customer can be doing at once.  When that limit is exceeded, ingestion<br>
will queue up the request for processing later.  The size of the queue has a separate limit, and when that is reached it will<br>
reject the ingestion request back to the customer (with a 409 error code, I believe.)  When jobs finish up, capacity<br>
is freed up and jobs that are queued will be picked up and processed one at a time.  Note that all limits are<br>
"per-customer", not global.</p>
<p>Before Priority Queueing, the job status in the CMS API did not reflect that the job was queued.  This changes with<br>
Priority Queueing, with a new state called "queued" being exposed from the CMS API.  So customers will now know that<br>
jobs are queued and not running.  This new status applies to both low and normal priority jobs.</p>
<h2>How Priority Queueing effects Ingestion</h2>
<p>Priority queueing allows the user to add a "priority" flag to their ingest request.  The only legal values (currently)<br>
are "low" and "normal."  Any other value will cause the request to be rejected by Wedge with a 422 error code.  When the user<br>
doesn't specify any priority, priority is treated as "normal".  Setting priority impacts how work is picked off the queue,<br>
it<strong>DOES****NOT</strong>impact the starting of work if no work is queued.  Here is a brief description of how Priority Queueing<br>
changes how work is picked off the queue:</p>
<ol>
<li>If there is capacity to run a job, then the job is run immediately.  This applies to both low and normal priority jobs.</li>
<li>If there is is no capacity for another job to run, the job is queued.</li>
<li>If there are jobs queue, then any new jobs are also queued.  This means that a new job can't start before queued jobs.</li>
<li>When there is capacity to run another job and there are queued jobs, a job is picked off the queue.</li>
<li>If there are ANY normal priority jobs in the queue, the oldest normal priority job will be picked.</li>
<li>If there are NO normal priority jobs in the queue, then the oldest low priority job will be picked.</li>
<li>Normal and Low priority jobs are treated the<strong>same</strong>for how many running jobs there can be.  There is 1<br>
"max running jobs" quota (JobsInFlight), independent of priority.  More on quotas later in the doc.</li>
<li>There are<strong>separate</strong>quotas for how many normal and low priority jobs can be queued (JobsInQueue and JobsInQueueLow,<br>
respectively.)  There is more on quotas later in the doc.</li>
</ol>
<h2>How Priority Queueing effects Zencoder</h2>
<p>If priority is set to low, then we will set the <code>low_priority=true</code> flag on the zencoder job.  This will change the<br>
behavior of Zencoder in several ways.  This is SOME of the ways, but not all.  NOTE: I would put a link here to the official<br>
documentation from Zencoder on the flag... except that I have not been given such a link.  The main focus of what<br>
setting low_priority does is to lower costs for processing that video.  To that end:</p>
<ol>
<li>low_priority Zencoder jobs are not assigned to encoding services ("workers") until all normal priority work is<br>
assigned.  Therefor, normal priority work takes precedence over low priority work.</li>
<li>When deciding to scale up the cluster (launch more workers) queued low priority jobs are ignored.  This can lead<br>
to a large backlog of low priority work, which has to be dealt with manually by ZC people launching spot workers.</li>
<li>If their worker cloud is too "full", they will not start new low priority work.  This reserves capacity for new<br>
normal priority work that comes in.  The limit (which is normally around 85% fullness) is changeable by ZC people<br>
via the Zencoder dashboard.</li>
<li>They have a setting that limits when work will be assigned to a worker based on remaining time within the billing hour.<br>
This means that "idle" workers will not be given new low priority work if their billing hour is nearly up, preventing<br>
low priority work from keeping the cluster from scaling down.  Normally this is set to "10 minutes", so if there is<br>
10 minutes or less in the "billing hour" on a worker, a new low priority job will NOT be assigned to it.</li>
<li>low_priority in Zencoder has a cross-account effect.  Normal priority work from ANY account will be processed before<br>
ANY low_priority work.</li>
</ol>
<p>Because of all these impacts on job startup within Zencoder, we expect that setting Zencoder's low_priority flag<br>
will slow down completion of ingest jobs.  Unfortunately, we won't know how much until we try it.</p>
<p>We were also given this warning sent by TAG (who send it to esmith), but written by Justin Greer, about the use of the<br>
low_priority flag:</p>
<p><code>Because large backlogs of jobs in the Zencoder queue can affect performance, this is best used for only small batches at a time (probably a thousand jobs, or 5000 outputs, whichever is lower). Using it in a spread-out manner rather than batches is even better.</code></p>
<p>Due to this, a separate feature was implemented by James via the per-publisher configuration supported in ingest-api.<br>
It lets us override the use of low_priority on Zencoder jobs, so it is always on or off for a customer.  The original<br>
use for this feature is to allow us to set specific accounts to always have low_priority set to true (like for trial<br>
accounts), but it could be used here if there is trouble when we always set Zencoder low_priority to true when<br>
ingest priority is set to low.  Using this per-account setting to override the low_priority flag on Zencoder would<br>
let us decouple the two features, if needed.</p>
<h1>What Priority Queueing IS and IS NOT</h1>
<h2>IS</h2>
<ol>
<li>A way publishers can give us a hint about how quickly they want a job started.</li>
<li>A way to better handle large amounts of ingest without the publisher having to monitor our capacity limits and send<br>
us new work when capacity opens up.</li>
<li>A way to allow publishers to send us large amounts of jobs without rejection (connected to the previous one.)</li>
<li>A tool to use a priority hint from customers to lower costs within Zencoder</li>
</ol>
<h2>IS NOT</h2>
<ol>
<li>This does NOT cause any job to be processed faster than it does today.  Period.</li>
<li>You can not say "I want to run this job next", and guarantee it will happen.</li>
</ol>
<h1>How it works and what has changed</h1>
<p>Within Ingestion, the vast majority of the changes are in the Job Processor.  This is because if there are no queued<br>
jobs then any job (low or normal priority) is started immediately, like before this feature.  The only change is due<br>
to setting <code>low_priorite=true</code> on the Zencoder job.  If there are queued jobs, then things change (as described above<br>
in the "How Priority Queueing effects Ingestion" section.)  Basically, normal priority work is always send to SWF for<br>
processing before low priority work.</p>
<h2>How priority works (And why it is a number in Dynamo)</h2>
<p>The entire logic for picking the next available job in the queue is done automatically by Dynamo.  Neat trick, huh?  There<br>
is an index called "account-id-priority-created-at-index" on the table that uses account_id for the primary key<br>
and priority_created_at as the sort key.  How this works depends on the fact that the priority_created_at field is<br>
sorted alphabetically (it is a String) along with depending on what the data in that field looks like.  The data is<br>
in the format <code>&lt;2 digit number for priority&gt;,</code>.  For example<br>
<code>01,2017-02-28T15:05:28.932024942Z</code>.  This puts the priority in front (i.e. most important to string sorting), ahead of<br>
when it was queued.</p>
<p>The code within ingest-api guarantees that priority low is converted into a two digit number that is HIGHER than the<br>
two digit number normal priority is converted to.  So normal priority jobs are sorted BEFORE low priority jobs.  So we<br>
just ask for the "smallest" in sort order and we automatically have the oldest message of normal priority, or (if<br>
there are no normal priority) the oldest low priority job.</p>
<p>Since only Dynamo knows/cares about this, the translation of string-to-number and number-to-string is done in<br>
queued_job_store.go and doesn't leak outside of that code.</p>
<p>Note that this implementation, how ever fast and kinda slick, limits us.  For example, without creating new indexes it<br>
would be hard to implement a system of more than 2 priorities and slowly "age" jobs up in priority.  But for how we use<br>
it now, this system works VERY well.  Dynamo is VERY fast at picking rows via this index, even when there are<br>
hundreds of thousands of queued jobs.</p>
<h2>Quotas</h2>
<p>There are now several new quotas in Goaltender, and some existing quotas have changed their meaning slightly.</p>
<ol>
<li>"JobsInFlight" is a<strong>quota</strong>that applies to all jobs regardless of priority.  It has a quota maximum just like before<br>
so if there are too many "jobs in flight" for a given publisher (independent of priority), then a job will be queued.</li>
<li>"JobsInFlightLow" is a<strong>counter</strong>that lets us know how many low priority jobs are in flight.  Note that there is NO<br>
maximum amount of low priority jobs in flight.  Low priority jobs are lumped into the number of jobs for the JobsInFlight<br>
quota.  JobsInFlightLow is there to help us with customer support related issues if someone calls and asks us why their<br>
jobs are not being processed in a timely manor.</li>
<li>"JobsInQueue" is a<strong>quota</strong>that applies to how many normal priority jobs are in the queue.  It has a maximum value, and<br>
if we exceed this the job will be rejected with a 409 error (I believe.)</li>
<li>"JobsInQueueLow" is a<strong>quota</strong>that applies to how many low priority jobs are in the queue.  It has a maximum value, but<br>
that value will (at least initially) be set so high that we don't expect any customer will hit it (probably 100,000).  If<br>
they did hit it we would reject the request with a 409 error (I believe.)  This was done so we can throttle the number<br>
of low priority jobs if we find there are problems with supporting so many low priority jobs.</li>
</ol>
<h2>The Job Queue</h2>
<p>Leveraging the Job Fairness functionality already in Bolt, jobs are queued in a dynamo table.  The base name of the<br>
table is "IngestQueuedJobsTable" with extra info added to the table name by our tools that manage table<br>
creation/modification.  The table has these fields:</p>
<ol>
<li>"account_id" - obvious.</li>
<li>"created_at" - Kinda obvious, when the row in dynamo was created.</li>
<li>"input" - a serialized string in JSON of data related to the job.  This can get BIG.</li>
<li>"job_id" - obvious.</li>
<li>"priority" - a string that holds a numeric value representing the priority.  Why this is a number is described below.</li>
<li>"priority_created_at" - A string that holds the concatenation of the priority and created_at fields.  The reasoning<br>
for this is described below.</li>
<li>"version" - The string 1.0.  I assume added to support changes to the table data/fields.  Currently always 1.0</li>
<li>"workflow_tags" - An array of the tags put on the workflow when the job is run.</li>
<li>"workflow_type" - A string that identifies the workflow that will be run in SWF for this job.</li>
</ol>
<h2>Billing differences</h2>
<p>In version 1.0 of Priority Queueing, there will be no difference in billing between normal and low priority.  But there<br>
is an idea that we could charge less for low priority jobs.  To that end, we pass in the priority flag<br>
(low or normal) into zencoder so they have the data they would need to effect billing.  The theory is that if we set<br>
the low_priority=true flag in Zencoder, it will cost us less to process that video.  This would save us money and we<br>
could pass a bit of that savings on to our customers (thereby encouraging them to use the feature.)</p>
<h1>Insight into priority queueing</h1>
<h2>Jackie Pages improvements.</h2>
<p>We have a list of ideas of how this information will be displayed.  This includes:</p>
<ol>
<li>What priority a job was at (available in the CMS API)</li>
<li>When it was submitted (available in the CMS API)</li>
<li>What the priority is within the SWF context</li>
<li>What the low_priority flag is set to is within the SWF context</li>
<li>How many jobs are in the queue, with the ability to drill down and see how many at each priority if you choose.</li>
</ol>
<h1>Limitations</h1>
<h2>Links with Expiration Dates</h2>
<p>Links with expiration dates should NOT be used with low priority jobs.  Users should not expect that a job will start<br>
quickly, and could take more than 24 hours to start (if thousands of low priority long videos are submitted, for<br>
example.)  That means that "Source File Upload" links might not be valid by the time the job is run.</p>
<h2>How long will processing take?</h2>
<p>Normal priority jobs will take no longer than before.  If a customer sends only normal priority jobs, there will be no<br>
difference.</p>
<p>Even removing the effect of low_priority on Zencoder processing, the impact of setting priority to low in Ingestion<br>
is very situational, and could be large.  If you have a large backlog of low priority jobs combined with a steady<br>
rate of normal jobs being submitted, the low priority jobs might take a VERY long time to be started.  This is<br>
the correct behavior from a technical standpoint, but until we see how the feature is used... we won't know what<br>
customers thing of this.  Low priority jobs will absolutely get processed<strong>when there is capacity and no normal<br>
jobs to run</strong>but we don't have complete control over when that happens.  It is the customer that sends those<br>
normal priority jobs, after all.</p>
</div></div>
      <script></script>
    </body>
    </html>
  