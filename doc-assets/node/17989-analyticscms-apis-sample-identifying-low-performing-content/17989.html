<article class="bcls-article">

  <section class="bcls-section">
  <h2 id="gettingCredentials" class="bcls-expander-head">Getting Credentials</h2>

  <div class="bcls-expander-content">
  <p>To get a <code>client_id</code> and <code>client_secret</code>, you will need to go to the OAuth UI and register this app:</p>

  <ul>
  	<li><a href="/node/14056">Managing API Authentication Credentials</a></li>
  </ul>

  <p>These are the permissions you will need:</p>

  <figure class="bcls-figure"><img class="bcls-image" alt="Analytics API Permissions" src="//learning-services-media.brightcove.com/doc-assets/video-cloud-apis/analytics-api/aapi-permissions.png" />
  <figcaption class="bcls-caption--image">Analytics API Permissions</figcaption>
  </figure>

  <p>You can also get your credentials via CURL or Postman - see:</p>

  <ul>
  	<li><a href="/node/17924">Get Client Credentials Using CURL</a></li>
  	<li><a href="/node/17923">Get Client Credentials Using Postman</a></li>
  </ul>

  <p>If you are getting credentials directly from the API, these are the permissions you need:</p>

  <pre class="line-numbers">
  <code class="language-json">[
    "video-cloud/analytics/read",
    "video-cloud/video/read"
  ]</code></pre>
  </div>
  </section>
<section class="bcls-section">
<h2 id="Request_Options">Request Options</h2>

<p>Where no default value is indicated, there is none.</p>

<div id="inputFields" class="input-fields">
<fieldset class="bcls-fieldset"><legend>Basic Information</legend>

<p>By default, you will get results from the Brightcove Learning Services sample account.</p>

<p><span class="bcls-button" id="useMyAccount">Use My Account Instead</span></p>

<div id="basicInfo" style="display:none;">
<table class="bcls-table">
	<tbody class="bcls-table__body">
		<tr>
			<td>Video Cloud Account (Publisher ID):</td>
			<td><input id="accountID" class="required aapi-request" type="text" size="55" /></td>
		</tr>
		<tr>
			<td class="align-top no-wrap">Client id:<br />
			(permissions for analytics/read and videos/read)</td>
			<td><input id="client_id" class="required aapi-request" type="text" size="100" value="" /></td>
		</tr>
		<tr>
			<td class="align-top no-wrap">Client secret:<br />
			(permissions for analytics/read and videos/read)</td>
			<td><input id="client_secret" class="required aapi-request" type="text" size="100" value="" /></td>
		</tr>
	</tbody>
</table>

<p class="small" id="n1"><sup class="red">[1]</sup> See <a href="/node/14056">Managing API Credentials</a> for information on getting client credentials.</p>
</div>
</fieldset>

<fieldset class="bcls-fieldset"><legend>Filters</legend>

<div id="filters">
<table class="bcls-table">
	<tbody class="bcls-table__body">
		<tr>
			<td>How many months back to check for views (default: 1 month):</td>
			<td><select class="aapi-request" id="fromMonths"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6" selected="selected">6</option></select></td>
		</tr>
		<tr>
			<td colspan="2">
			<p>Exclude videos added within the last <select class="aapi-request" id="excludeMonths"><option value="0">0</option><option value="1" selected="selected">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option></select> months (by default, videos added in the last month are excluded)</p>
			</td>
		</tr>
		<tr>
			<td colspan="2">
			<p>Report videos with less than <select class="aapi-request" id="includeVideos"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5" selected="selected">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option></select> views during the period (default: 5 views)</p>
			</td>
		</tr>
		<tr>
			<td>Total videos to return:</td>
			<td><input class="aapi-request" id="totalVideos" type="text" size="10" value="all" /><span style="font-size:small"> by default, all videos in your account, starting with the oldest, will be returned. If you wish to return a smaller number, enter it here. Remember that the more videos you request, the longer the app will take to run, and the more likely that timeout errors will occur.</span></td>
		</tr>
	</tbody>
</table>
</div>
</fieldset>
</div>
</section>

<section class="bcls-section">
<h2 id="The_API_Request">The API Request</h2>

<div id="requestSubmitter">
<fieldset class="bcls-fieldset"><legend>Generated Request</legend>

<p>API Request</p>

<p><textarea id="request" name="request" class="bcls-code">API request will appear here...</textarea></p>
</fieldset>

<p><span class="bcls-button" id="submitButton">Generate the Report</span></p>
</div>
</section>

<section class="bcls-section">
<h2 id="Response">Response</h2>

<div id="response">
<p><span class="bcls-button" id="csvButton">Convert Data to CSV</span> <span class="bcls-button" id="selectData">Select the Data to Copy</span></p>
<textarea id="responseFrame" class="bcls-code" style="height:20em;">Response will appear here...</textarea></div>
</section>

<section class="bcls-section">
<h2 id="code">Code for this app</h2>

<h3>HTML</h3>

<p>View the source of this page to see the HTML code.</p>

<h3>JavaScript</h3>

<pre class="line-numbers">
<code class="language-javascript">var BCLS = (function (window, document) {
    'use strict';
    var videoData = [],
        analyticsData = [],
        videoIdsArray = [],
        lastPublishedDate,
        totalVideos = null,
        videoCount = 0,
        totalVideoCalls = 0,
        callNumber = 0,
        pageNumber = 0,
        params = {},
        // aapi stuff
        proxyURL = 'https://solutions.brightcove.com/bcls/bcls-proxy/non-performing-videos-proxy.php',
        useMyAccount = document.getElementById('useMyAccount'),
        basicInfo = document.getElementById('basicInfo'),
        accountID = document.getElementById('accountID'),
        account_id = '1752604059001',
        $client_id = document.getElementById('client_id'),
        $client_secret = document.getElementById('client_secret'),
        client_id = null,
        client_secret = null,
        $totalVideos = document.getElementById('totalVideos'),
        limit = 25,
        $fromMonths = document.getElementById('fromMonths'),
        $excludeMonths = document.getElementById('excludeMonths'),
        $includeVideos = document.getElementById('includeVideos'),
        $request = document.getElementById('request'),
        $submitButton = document.getElementById('submitButton'),
        $csvButton = document.getElementById('csvButton'),
        $selectData = document.getElementById('selectData'),
        $responseFrame = document.getElementById('responseFrame'),
        mMonth = 2592000000,
        now = new Date(),
        from,
        oldestPubDate = now.valueOf() - ($excludeMonths.value * mMonth),
        requestTrimmed = false,
        lastChar = '',
        requestURL = '',
        totalAnalyticsCalls = 0,
        analyticsCallNumber = 0,
        i,
        len,
        minViews = $includeVideos.value;

    /**
     * Logging function - safe for IE
     * @param  {string} context - description of the data
     * @param  {*} message - the data to be logged by the console
     * @return {}
     */
    function bclslog(context, message) {
        if (window['console'] &amp;&amp; console['log']) {
          console.log(context, message);
        }
        return;
    }


    // more robust test for strings 'not defined'
    function isDefined(v) {
        if (v === '' || v === null || v === undefined || v === NaN) {
            return false;
        }
        return true;
    }

    function removeSpaces(str) {
        if (isDefined(str)) {
            str = str.replace(/\s+/g, '');
            return str;
        }
    }

    function trimRequest() {
        if (!requestTrimmed) {
            lastChar = requestURL.charAt((requestURL.length - 1));
            if (lastChar === '?' || lastChar === '&amp;' || lastChar === ';') {
                requestURL = requestURL.substring(0, (requestURL.length - 1));
                // recall this function until trim finished
                trimRequest(requestURL);
            } else if (requestURL.indexOf('&amp;&amp;') &gt; -1) {
                requestURL = requestURL.replace('&amp;&amp;', '&amp;');
            } else if (requestURL.indexOf('?&amp;') &gt; -1) {
                requestURL = requestURL.replace('?&amp;', '?');
            } else {
                requestTrimmed = true;
            }
        }
    }

    /**
     * find index of an object in array of objects
     * based on some property value
     *
     * @param {array} targetArray array to search
     * @param {string} objProperty object property to search
     * @param {string} value of the property to search for
     * @return {integer} index of first instance if found, otherwise returns -1
    */
    function findObjectInArray(targetArray, objProperty, value) {
        var i, totalItems = targetArray.length, objFound = false;
        for (i = 0; i &lt; totalItems; i++) {
            if (targetArray[i][objProperty] === value) {
                objFound = true;
                return i;
            }
        }
        if (objFound === false) {
            return -1;
        }
    }

    /**
     * Builds the API requests and handles responses
     * @param {String} type the request type (getCount | getVideos | getAnalytics)
     */
    function buildRequest(type) {
        var requestOptions = {},
            tmpArray,
            newVideoItem = {},
            currentIndex,
            videoItem,
            i;
        // add credentials if submitted
        if (isDefined(client_id) &amp;&amp; isDefined(client_secret)) {
            requestOptions.client_id = client_id;
            requestOptions.client_secret = client_secret;
        }
        switch (type) {
            case 'getCount':
                requestOptions.url = 'https://cms.api.brightcove.com/v1/accounts/' + account_id + '/counts/videos?q=published_at:..' + lastPublishedDate;
                $request.textContent = requestOptions.url;
                getData(requestOptions, type, function(response) {
                    totalVideos = response.count;
                    buildRequest('getVideos');
                });
                break;
            case 'getVideos':
                totalVideoCalls = Math.ceil(totalVideos / limit);
                requestOptions.url = 'https://cms.api.brightcove.com/v1/accounts/' + account_id + '/videos?q=published_at:..' + lastPublishedDate + '&amp;limit=' + limit + '&amp;offset=' + (limit * callNumber) + '&amp;sort=published_at';
                getData(requestOptions, type, function(response) {
                    // add the current item array to overall one
                    response.forEach(function(video, index, response){
                        newVideoItem = {};
                        newVideoItem.id = video.id;
                        newVideoItem.name = video.name;
                        newVideoItem.published_at = video.published_at;
                        newVideoItem.video_view = 0;
                        newVideoItem.engagement_score = 0;
                        newVideoItem.video_percent_viewed = 0;
                        videoData.push(newVideoItem);
                        // add the video id to the video ids array
                        videoIdsArray.push(video.id);
                    });
                    callNumber++;
                    if (callNumber &lt; totalVideoCalls) {
                        // still have more videos to get
                        buildRequest('getVideos');
                    } else {
                        // reset callNumber
                        callNumber = 0;
                        buildRequest('getAnalytics');
                    }
                });
                break;
            case 'getAnalytics':
                // because of URL length restrictions, we can get up to 150 videos at a time
                totalAnalyticsCalls = Math.ceil(videoIdsArray.length / 150);
                tmpArray = videoIdsArray.slice((callNumber * 150), ((callNumber * 150) + 150));
                account_id = (isDefined(accountID.value)) ? accountID.value : account_id;
                minViews = parseInt($includeVideos.value);
                requestOptions.url = 'https://analytics.api.brightcove.com/v1';
                requestOptions.url += '/data?accounts=' + account_id + '&amp;dimensions=video&amp;limit=150';
                // add where filter
                requestOptions.url += '&amp;where=video==' + tmpArray.join(',');
                // add from date
                requestURL += '&amp;from=' + from;
                // add fields
                requestURL += '&amp;fields=video,engagement_score,video_view,video_percent_viewed';
                $request.textContent = requestOptions.url;
                $request.setAttribute('value', requestURL);
                getData(requestOptions, type, function(response) {
                    analyticsData = analyticsData.concat(response.items);
                    callNumber++;
                    if (callNumber &lt; totalAnalyticsCalls) {
                        buildRequest('getAnalytics');
                    } else {
                        // remove items with more than the minimum views
                        i = analyticsData.length;
                        while (i &gt; 0) {
                            i--;
                            if (analyticsData[i].video_view &gt; minViews) {
                                analyticsData.splice(i, 1);
                            }
                        }
                        // update analytics properties in the video data
                        analyticsData.forEach(function(item, index, analyticsData) {
                            currentIndex = findObjectInArray(videoData, 'id', item.video);
                            videoItem = videoData[currentIndex];
                            videoItem.video_view = item.video_view;
                            // engagement score and percent viewed may be undefined
                            videoItem.engagement_score = (isDefined(videoItem.engagement_score)) ? item.engagement_score : 0;
                            videoItem.video_percent_viewed = (isDefined(videoItem.video_percent_viewed)) ? item.video_percent_viewed : 0;
                        });
                        // if video items did not show up in analytics results, engagement score and percent viewed may be undefined
                        videoData.forEach(function(video, index, videoData) {
                            if (!isDefined(video.engagement_score)) {
                                video.engagement_score = 0;
                            }
                            if (!isDefined(video.video_percent_viewed)) {
                                video.video_percent_viewed = 0;
                            }
                        });
                        $responseFrame.textContent = JSON.stringify(videoData, null, "  ");
                    }
                });
                break;
        }

    }
    /**
     * send API request to the proxy
     * @param  {Object} requestData options for the request
     * @param  {String} requestID the type of request = id of the button
     * @param  {Function} callback the callback function to invoke
     */
    function getData(options, type, callback) {
        var httpRequest = new XMLHttpRequest(),
            parsedData,
            requestParams,
            dataString,
            // response handler
            getResponse = function() {
                try {
                  if (httpRequest.readyState === 4) {
                    if (httpRequest.status &gt;= 200 &amp;&amp; httpRequest.status &lt; 300) {
                      parsedData = JSON.parse(httpRequest.responseText);
                      callback(parsedData);
                    } else {
                      alert('There was a problem with the request. Request returned ' + httpRequest.status);
                    }
                  }
                } catch (e) {
                  alert('Caught Exception: ' + e);
                }
            };
            // set up request data
        requestParams = 'url=' + encodeURIComponent(options.url) + '&amp;requestType=GET';
        if (options.client_id &amp;&amp; options.client_secret) {
            requestParams += '&amp;client_id=' + options.client_id + '&amp;client_secret=' + options.client_secret;
        }

        // set response handler
        httpRequest.onreadystatechange = getResponse;
        // open the request
        httpRequest.open('POST', proxyURL);
        // set headers
        httpRequest.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        // open and send request
        httpRequest.send(requestParams);
    }

    // convert data to CSV
    function jsonToCSV() {
        // templates are built dynamically to allow for additional fields added later
        var headersRow = '',
            textRows = '',
            tmpArray = [],
            prop,
            i,
            iMax,
            video,
            str;
        $responseFrame.textContent = 'Loading CSV data...';
        // build header row
        headersRow = '"ID","Name","Published Date","Video Views","Engagement Score","Video Percent Viewed" \n';
        // build rows
        tmpArray = [];
        iMax = videoData.length;
        for (i = 0; i &lt; iMax; i++) {
            video = videoData[i];
            tmpArray = [video.id, video.name, video.published_at,video.video_view,video.engagement_score,video.video_percent_viewed];
            textRows += tmpArray.join(',') + '\n';
        }
        str = headersRow + textRows;
        $responseFrame.textContent = str;
    }

    // set event listeners
    useMyAccount.addEventListener('click', function () {
        if (basicInfo.getAttribute('style') === 'display:none;') {
            basicInfo.setAttribute('style', 'display:block;');
            useMyAccount.innerHTML = 'Use Sample Account';
        } else {
            basicInfo.setAttribute('style', 'display:none;');
            useMyAccount.innerHTML = 'Use My Account Instead';
        }
    });
    // send request
    $submitButton.addEventListener('click', function () {
        // get input values
        if (isDefined($client_id.value)) {
            client_id = $client_id.value;
        }
        if (isDefined($client_secret.value)) {
            client_secret = $client_secret.value;
        }
        if (isDefined(accountID.value)) {
            account_id = accountID.value;
        }
        from = now.valueOf() - ($fromMonths.value * mMonth);
        oldestPubDate = now.valueOf() - ($excludeMonths.value * mMonth);
        lastPublishedDate = new Date(oldestPubDate).toISOString();
        bclslog('lastPublishedDate', lastPublishedDate);
        minViews = $includeVideos.value;
        // generate initial request
        // if total videos not defined, get count
        if ($totalVideos.value !== 'all') {
            totalVideos = $totalVideos.value;
            buildRequest('getVideos');
        } else {
            buildRequest('getCount');
        }
    });
    // convert to csv
    $csvButton.addEventListener('click', jsonToCSV);
    // select all the data
    $selectData.addEventListener('click', function () {
        document.getElementById('responseFrame').select();
    });
    // set initial value of from
    from = now.valueOf() - mMonth;

    return {
        buildRequest: buildRequest
    };
})(window, document);</code></pre>

<h3>Proxy</h3>

<aside class="bcls-aside bcls-aside--information">In order to build your own version the sample app on this page, you must create and host your own proxy. (The proxies used by Brightcove Learning Services only accept requests from Brightcove domains.) You can download two versions of our proxy code:
<ul>
	<li><a href="//learning-services-media.brightcove.com/doc-assets/proxy/bcls-proxy-for-distribution.php.zip">This is a general version that expects client credentials to be passed with the request</a></li>
	<li><a href="//learning-services-media.brightcove.com/doc-assets/proxy/doc-samples-proxy.php.zip">This version allows you to save your client credentials in the proxy itself on lines 25-26 (recommended)</a></li>
</ul>
</aside>
</section>
</article>
<script src="//learning-services-media.brightcove.com/doc-assets/node/17989-analyticscms-apis-sample-identifying-low-performing-content/old-videos-with-few-views.js"></script>
