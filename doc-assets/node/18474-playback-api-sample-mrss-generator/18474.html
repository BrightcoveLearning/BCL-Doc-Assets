<link rel="stylesheet" href="https://learning-services-media.brightcove.com/doc-assets/js/rome/rome.min.css" />
<article class="bcls-article">
<section class="bcls-section">
<h2 id="Alternative_samples">Alternative samples</h2>

<p>We have some additional samples of generating MRSS feeds using the CMS API via a proxy app:</p>

<ul>
	<li><a href="/node/18028">CMS API Sample: MRSS Generator</a></li>
	<li><a href="/node/18026">CMS API Sample: MRSS Feed from Playlist</a></li>
</ul>

<p>You may also be interested in this <a href="https://github.com/registerguard/brightcove-cms-api-php-rss">alternative sample</a> created in PHP alone by a Brightcove customer.</p>

<p>The only advantage of using the Playback API over the CMS API is that the app is entirely client side - no server-side proxy is required to get access tokens.</p>
</section>

<section class="bcls-section">
<h2 id="Authentication">Authentication</h2>

<p>Requests are authenticated by a policy key, which can be passed in one of three ways:</p>

<ol>
	<li>In an argument to an <code class="notranslate">Accept</code> header:

	<pre class="line-numbers">
<code class="language-http">Accept: application/json;pk={policy_key}</code></pre>

	<p>This is the recommended method for a browser-based client, because it allows the request to go ahead without an extra request first as part of the browser CORS "pre-flight" checking. This saves latency on the first time a browser request is made.</p>
	</li>
	<li>In an <code class="notranslate">Authorization</code> header using the realm keyword <code class="notranslate">BCOV-Policy</code>:
	<pre class="line-numbers">
<code class="language-http">Authorization: BCOV-Policy {policy_key}</code></pre>
	</li>
	<li>In a <code class="notranslate">BCOV-Policy</code> header:
	<pre class="line-numbers">
<code class="language-http notranslate">BCOV-Policy: {policy_key}</code></pre>
	</li>
</ol>

<h3>Obtaining a policy key</h3>

<p>There are three ways you can obtain a policy key:</p>

<ol>
	<li>Every Brightcove player is automatically assigned one. You can find instructions for getting a player's policy key in <a href="/node/18125">this document</a>. Since policy keys are good account-wide, you can use it regardless of whether that player is embedded on the page.</li>
	<li>You can generate a basic policy key using the <a href="/node/18004">Policy Keys Quick Start</a></li>
	<li>You can make a request to the <a href="/node/18003">Policy API</a></li>
</ol>
</section>

<section class="bcls-section">
<h2 id="dependencies">Dependencies</h2>

<ul>
	<li><a href="https://github.com/vkiryukhin/vkBeautify">vkBeautify</a> (to pretty-print the XML for the MRSS feed)</li>
</ul>
</section>

<section class="bcls-section">
<h2 id="workingSample">Working sample</h2>

<p>You can use the form below to generate a sample MRSS feed either for your own account or for a sample Brightcove account.</p>

<fieldset class="bcls-fieldset"><legend>Input</legend>

<p>If you do not enter account information, a Brightcove sample account will be used.</p>

<p>Account id: <input id="account_id" type="text" value="" placeholder="1752604059001" /></p>

<p>Policy key: <input id="policy_key" type="text" size="60" value="" placeholder="BCpkADawqM2KZhoCftdQooqAvN7vGBxeWbqhorS9KciUZ92NYSveS_vZpn" /></p>

<p>Feed title: <input type="text" id="feedTitle" value="MRSS Feed" /></p>

<p>Feed description: <input type="text" id="feedDescription" value="My MRSS Feed" /></p>

<p>Number of videos to include: <select name="numberSelect" id="numberSelect" style="width:100px;"><option value="25" selected="selected">25</option><option value="50">50</option><option value="100">100</option> <!-- <option value="all">all</option> --></select></p>

<p>Search string to select videos (optional - see <a href="/node/18005">Search for Videos</a>) <input id="searchStr" type="text" placeholder="tags:foo" /></p>

<p>Sort by: <select name="sortSelect" id="sortSelect" style="width:150px;"><option value="updated_at" selected="selected">Date last updated</option><option value="created_at">Date added</option></select><select name="directionSelect" id="directionSelect" style="width:120px;"><option value="-" selected="selected">descending</option><option value="">ascending</option></select></p>

<table class="bcls-table">
	<caption>Limit search by dates:</caption>
	<tbody>
		<tr>
			<td>Date type</td>
			<td>From date</td>
			<td>To date</td>
		</tr>
		<tr>
			<td><select class="date-field" id="dateRangeType" style="width:200px;font-size:1.3rem;"><option class="notranslate" value="created_at" selected="selected">created_at</option><option class="notranslate" value="updated_at">updated_at</option><option class="notranslate" value="published_at">published_at</option><option class="notranslate" value="schedule.starts_at">schedule.starts_at</option><option class="notranslate" value="schedule.ends_at">schedule.ends_at</option> </select></td>
			<td><input id="fromDate" class="date-field" style="width:200px;font-size:1.3rem;" /></td>
			<td><input id="toDate" class="date-field" style="width:200px;font-size:1.3rem;" /></td>
		</tr>
	</tbody>
</table>

<p><button class="bcls-button" id="makeFeed">Generate the Feed</button></p>
</fieldset>

<fieldset class="bcls-fieldset"><legend>Output</legend>

<p id="logger" style="color:rgb(237, 104, 38)">Waiting for input...</p>

<p>Current API request</p>

<pre>
<code id="apiRequest">API request will appear here...</code></pre>

<p>Generated MRSS feed</p>
<textarea id="feedDisplay" style="width:95%;height:30em;"></textarea></fieldset>
</section>

<section class="bcls-section">
<h2 id="javascript">Code for this app</h2>

<h3>HTML</h3>

<p>To see the HTML code used in this app, view the source for this page.</p>

<h3>JavaScript</h3>

<p>Below is the JavaScript code used for this app. If the code does not appear, try refreshing the page.</p>

<pre class="line-numbers">
<code class="language-javascript">var BCLS = ( function (window, document) {
    var mrssStr = '&lt;rss version="2.0" xmlns:media="http://search.yahoo.com/mrss/" xmlns:dcterms="http://purl.org/dc/terms/"&gt;',
    sChannel = '&lt;channel&gt;',
    eChannel = '&lt;/channel&gt;',
    sTitle = '&lt;title&gt;',
    eTitle = '&lt;/title&gt;',
    sDescription = '&lt;description&gt;',
    eDescription = '&lt;/description&gt;',
    sItem = '&lt;item xmlns:media="http://search.yahoo.com/mrss/" xmlns:dcterms="http://purl.org/dc/terms/"&gt;',
    defaultEndDate = '2020-10-15T00:00+01:00',
    eItemStart = '&lt;dcterms:valid xmlns:dcterms="http://purl.org/dc/terms/"&gt;end=',
    eItemEnd = '; scheme=W3C-DTF&lt;/dcterms:valid&gt;&lt;dcterms:type&gt;live-video&lt;/dcterms:type&gt;&lt;/item&gt;',
    sLink = '&lt;link&gt;',
    eLink = '&lt;/link&gt;',
    sPubDate = '&lt;pubDate&gt;',
    ePubDate = '&lt;/pubDate&gt;',
    sMediaContent = '&lt;media:content',
    eMediaContent = '&lt;/media:content&gt;',
    sMediaPlayer = '&lt;media:player',
    eMediaPlayer = '/&gt;',
    sMediaDescription = '&lt;media:description&gt;',
    eMediaDescription = '&lt;/media:description&gt;',
    sMediaThumbnail = '&lt;media:thumbnail',
    eMediaThumbnail = '/&gt;',
    sMediaTitle = '&lt;media:title&gt;',
    eMediaTitle = '&lt;/media:title&gt;',
    // account stuff
    accountId,
    default_accountId = '1752604059001',
    policyKey,
    default_policyKey = 'BCpkADawqM1eifBpAkEr4aJrH9i950qErQCg8FvHXBCigF0JjC-zZyhN4T1XGGGBbB0hojevaABtp54BTvT9Er0KplSpC6tqm8YgyCtIzGl5sc77i23GLWYdpLdtF7Aei45EuLqlUznlkiXU',
    // api stuff
    baseURL = 'https://edge.api.brightcove.com/playback/v1/accounts/',
    sort,
    sortDirection = "",
    search,
    limit = 25,
    totalVideos = 0,
    totalCalls = 0,
    callNumber = 0,
    videosArray = [],
    // elements
    account_id = document.getElementById('account_id'),
    policy_key = document.getElementById('policy_key'),
    feedTitle = document.getElementById('feedTitle'),
    feedDescription = document.getElementById('feedDescription'),
    numberSelect = document.getElementById('numberSelect'),
    searchStr = document.getElementById('searchStr'),
    sortSelect = document.getElementById('sortSelect'),
    directionSelect = document.getElementById('directionSelect'),
    dateRangeType = document.getElementById('dateRangeType'),
    fromDate = document.getElementById('fromDate'),
    toDate = document.getElementById('toDate'),
    dateTypeValue,
    fromDateValue,
    toDateValue,
    makeFeed = document.getElementById('makeFeed'),
    logger = document.getElementById('logger'),
    apiRequest = document.getElementById('apiRequest'),
    feedDisplay = document.getElementById('feedDisplay'),
    allButtons = document.getElementsByName('button');

    /**
     * tests for all the ways a variable might be undefined or not have a value
     * @param {String|Number} x the variable to test
     * @return {Boolean} true if variable is defined and has a value
     */
    function isDefined(x){
        if ( x === '' || x === null || x === undefined) {
            return false;
        }
        return true;
    }

    /**
     * get selected value for single select element
     * @param {htmlElement} e the select element
     */
    function getSelectedValue(e) {
        return e.options[e.selectedIndex].value;
    }


    /**
     * disables all buttons so user can't submit new request until current one finishes
     */
    function disableButtons() {
        var i,
            iMax = allButtons.length;
        for (i = 0; i &lt; iMax; i++) {
            allButtons[i].setAttribute('disabled', 'disabled');
        }
    }

    /**
    * re-enables all buttons
    */
    function enableButtons() {
        var i,
        iMax = allButtons.length;
        for (i = 0; i &lt; iMax; i++) {
            allButtons[i].removeAttribute('disabled');
        }
    }

    /**
     * sort an array of objects based on an object property
     * @param {array} targetArray - array to be sorted
     * @param {string|number} objProperty - object property to sort on
     * @return sorted array
     */
    function sortArray(targetArray, objProperty) {
        targetArray.sort(function (b, a) {
            var propA = a[objProperty], propB = b[objProperty];
            // sort ascending; reverse propA and propB to sort descending
            if (propA &lt; propB) {
                 return -1;
            } else if (propA &gt; propB) {
                 return 1;
            } else {
                 return 0;
            }
        });
        return targetArray;
    }

    function processSources(sources) {
        var i = sources.length;
        // remove non-MP4 sources
        // while (i &gt; 0) {
        //     i--;
        //     if (sources[i].container !== 'MP4') {
        //         sources.splice(i, 1);
        //     } else if (sources[i].hasOwnProperty('stream_name')) {
        //         sources.splice(i, 1);
        //     }
        // }
        // sort sources by encoding rate
        sortArray(sources, 'encoding_rate');
        // return the first item (highest bitrate)
        return sources[0];
    }

    function addItems() {
        var i, iMax, video, pubdate, eItem, videoURL, thumbnailURL, doThumbnail = true;
        if (videosArray.length &gt; 0) {
            iMax = videosArray.length;
            for (i = 0; i &lt; iMax; i += 1) {
                video = videosArray[i];
                // video may not have a valid source
                if (isDefined(video.source) &amp;&amp; isDefined(video.source.src)) {
                    videoURL = encodeURI(video.source.src.replace(/&amp;/g, '&amp;'));
                } else {
                    videoURL = "";
                }
                // depending on when/how the video was created, it may have different thumbnail properties or none at all
                if (isDefined(video.images) &amp;&amp; isDefined(video.images.thumbnail)) {
                    thumbnailURL = encodeURI(video.images.thumbnail.sources[0].src.replace(/&amp;/g, '&amp;'));
                } else if (isDefined(video.thumbnail)) {
                    thumbnailURL = encodeURI(video.thumbnail.replace(/&amp;/g, '&amp;'));
                } else {
                    doThumbnail = false;
                }

                pubdate = new Date(video.created_at).toGMTString();
                mrssStr += sItem;
                mrssStr += sLink + 'https://players.brightcove.net/' + accountId + '/default_default/index.html?videoId=' + video.id + eLink;
                mrssStr += sPubDate + pubdate + ePubDate;
                mrssStr += sMediaContent + ' url="' + videoURL + '" fileSize="' + video.source.size + '" type="video/quicktime" medium="video" duration="' + video.duration / 1000 + '" isDefault="true" height="' + video.source.height + '" width="' + video.source.width + '"&gt;';
                mrssStr += sMediaPlayer + ' url="' + 'https://players.brightcove.net/' + accountId + '/default_default/index.html?videoId=' + video.id + '"' + eMediaPlayer;
                mrssStr += sMediaTitle + video.name + eMediaTitle;
                mrssStr += sMediaDescription + video.description + eMediaDescription;
                if (doThumbnail) {
                    mrssStr += sMediaThumbnail + ' url="' + thumbnailURL + '"';
                    if (isDefined(video.images)) {
                        mrssStr += ' height="' + video.images.thumbnail.sources[0].height + '" width="' + video.images.thumbnail.sources[0].width + '"' + eMediaThumbnail;
                    } else {
                        mrssStr += eMediaThumbnail;
                    }
                }
                mrssStr += eMediaContent;
                if (isDefined(video.schedule) &amp;&amp; video.schedule.ends_at) {
                    eItem = eItemStart + video.schedule.ends_at + eItemEnd;
                } else {
                    eItem = eItemStart + defaultEndDate + eItemEnd;
                }
                mrssStr += eItem;
            }
        }
        mrssStr += eChannel + '&lt;/rss&gt;';
        logger.textContent = 'Finished!';
        feedDisplay.textContent = vkbeautify.xml(mrssStr);
        enableButtons();
    }

    /**
     * sets up the data for the API request
     * @param {String} id the id of the button that was clicked
     */
    function setRequestData(id) {
        var endPoint = '',
            requesturl;
        // disable buttons to prevent a new request before current one finishes
        disableButtons();
        switch (id) {
            case 'getVideos':
                var callback = function(response) {
                    var i,
                        iMax,
                        parsedData;
                    parsedData = JSON.parse(response);
                    videosArray = parsedData.videos;
                    console.log('videosArray', videosArray);
                    // for each video, get the best source and set that as source
                    iMax = videosArray.length;
                    for (i = 0; i &lt; iMax; i++) {
                        videosArray[i].source = processSources(videosArray[i].sources);
                    }
                    addItems();
                };
            endPoint = accountId + '/videos?sort=' + sort + '&amp;limit=' + limit;
            if (isDefined(search)) {
                endPoint += '&amp;q=' + search;
            }
            requesturl = baseURL + endPoint;
            apiRequest.textContent = requesturl;
            getMediaData(requesturl, id, callback);
                break;
        }
    }

    /**
     * send API request to the proxy
     * @param  {Object} requestData options for the request
     * @param  {String} requestID the type of request = id of the button
     * @param  {Function} [callback] callback function
     */
    function getMediaData(requesturl, requestID, callback) {
        var httpRequest = new XMLHttpRequest(),
            parsedData,
            requestParams,
            dataString,
            sources,
            // response handler
            getResponse = function() {
                try {
                    if (httpRequest.readyState === 4) {
                        if (httpRequest.status &gt;= 200 &amp;&amp; httpRequest.status &lt; 300) {
                            // check for completion
                            if (requestID === 'getVideos') {
                                    callback(httpRequest.responseText);
                            } else {
                              alert('There was a problem with the request. Request returned ' + httpRequest.status);
                            }
                        }
                    }
                } catch (e) {
                  alert('Caught Exception: ' + e);
                }
            };
        // set response handler
        httpRequest.onreadystatechange = getResponse;
        // open the request
        httpRequest.open('GET', requesturl);
        // set headers
        httpRequest.setRequestHeader("BCOV-Policy", policyKey);
        // open and send request
        httpRequest.send();
    }

    function init() {
        // date pickers
        rome(fromDate);
        rome(toDate);
        // event handlers
        makeFeed.addEventListener('click', function() {
            var numVideos;
            // get the inputs
            policyKey = policy_key.value;
            accountId = account_id.value;
            // only use entered account id if client id and secret are entered also
            if (isDefined(accountId)) {
                if (!isDefined(policyKey)) {
                    window.alert('To use your own account, you must provide your own policy key - since it is missing, a sample account will be used');
                    policyKey = default_policyKey;
                    accountId = default_accountId;
                }
            } else {
                policyKey = default_policyKey;
                accountId = default_accountId;
            }
            sort = getSelectedValue(sortSelect);
            sortDirection = getSelectedValue(directionSelect);
            if (isDefined(sortDirection)) {
                sort = sortDirection + sort;
            }
            search = searchStr.value;
            dateTypeValue = getSelectedValue(dateRangeType);
            fromDateValue = rome(fromDate).getDate();
            if (isDefined(fromDateValue)) {
                fromDateValue = fromDateValue.toISOString();
                if (isDefined(search)) {
                    search += '%20+';
                }
                search += dateTypeValue + ':' + fromDateValue + '..';
            }
            toDateValue = rome(toDate).getDate();
            if (isDefined(toDateValue)) {
                toDateValue = toDateValue.toISOString();

                if (isDefined(fromDateValue)) {
                    search += toDateValue;
                } else {
                    if (isDefined(search)) {
                        search += '%20+';
                    }
                    search += dateTypeValue + ':..' + toDateValue;
                }
            }
            search = encodeURI(search);
            numVideos = getSelectedValue(numberSelect);
            // add title and description
            mrssStr += sChannel + sTitle + feedTitle.value + eTitle + sDescription + feedDescription.value + eDescription;
            totalVideos = parseInt(numVideos);
            totalCalls = numVideos;
            logger.textContent = 'Total videos to retrieve: ' + totalVideos;
            setRequestData('getVideos');
        });
        feedDisplay.addEventListener('click', function() {
            feedDisplay.select();
        });
    }

    init();
})(window, document);
</code></pre>
</section>
</article>
<!-- date picker --><script src="https://learning-services-media.brightcove.com/doc-assets/js/rome/rome.min.js"></script><script src="https://learning-services-media.brightcove.com/doc-assets/node/18474-playback-api-sample-mrss-generator/vkbeautify.0.99.00.beta.js"></script><script src="https://learning-services-media.brightcove.com/doc-assets/node/18474-playback-api-sample-mrss-generator/mrss-generator.js"></script>
